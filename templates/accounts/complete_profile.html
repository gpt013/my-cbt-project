{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    .errorlist {
        color: #dc3545;
        font-weight: bold;
        list-style: none;
        padding-left: 0;
        font-size: 0.9em;
    }
</style>

<div class="container" style="max-width: 600px;">
    <div class="card mt-5 mb-5">
        <div class="card-header">
            <h3 class="text-center">개인 정보 입력 (필수)</h3>
            <p class="text-center text-muted mb-0">사이트를 이용하려면 먼저 개인 정보를 입력해야 합니다.</p>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                
                <fieldset class="mt-4">
                    <legend class="fs-5 border-bottom mb-3 pb-2">개인 정보</legend>
                    
                    <div class="mb-3">
                        <label for="{{ profile_form.company.id_for_label }}" class="form-label">{{ profile_form.company.label }}</label>
                        {{ profile_form.company.errors }}
                        {{ profile_form.company }}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ profile_form.name.id_for_label }}" class="form-label">{{ profile_form.name.label }}</label>
                        {{ profile_form.name.errors }}
                        <input type="text" name="name" value="{{ profile_form.name.value|default:'' }}" class="form-control" required id="{{ profile_form.name.id_for_label }}">
                    </div>

                    <div class="mb-3">
                        <label for="{{ profile_form.employee_id.id_for_label }}" class="form-label">{{ profile_form.employee_id.label }}</label>
                        {{ profile_form.employee_id.errors }}
                        <input type="text" name="employee_id" value="{{ profile_form.employee_id.value|default:'' }}" class="form-control" required id="{{ profile_form.employee_id.id_for_label }}">
                    </div>

                    <div class="mb-3">
                        <label for="{{ profile_form.cohort.id_for_label }}" class="form-label">{{ profile_form.cohort.label }}</label>
                        {{ profile_form.cohort.errors }}
                        {{ profile_form.cohort }}
                    </div>
                    <div class="mb-3">
                        <label for="{{ profile_form.process.id_for_label }}" class="form-label">{{ profile_form.process.label }}</label>
                        {{ profile_form.process.errors }}
                        {{ profile_form.process }}
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ profile_form.line.label }}</label>
                        {{ profile_form.line }}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ profile_form.pl.id_for_label }}" class="form-label">{{ profile_form.pl.label }}</label>
                        {{ profile_form.pl.errors }}
                        {{ profile_form.pl }}
                    </div>
                    </fieldset>
                
                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-primary">저장 및 사이트 이용 시작</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        
        const companySelect = document.getElementById("{{ profile_form.company.id_for_label }}");
        const processSelect = document.getElementById("{{ profile_form.process.id_for_label }}");
        const plSelect = document.getElementById("{{ profile_form.pl.id_for_label }}");

        const url = "{% url 'accounts:ajax_load_part_leaders' %}";

        function resetPLSelect(message, disabled) {
            plSelect.innerHTML = "";
            const option = document.createElement("option");
            option.value = "";
            option.textContent = message;
            plSelect.appendChild(option);
            plSelect.disabled = disabled;
        }

        function updatePartLeaders() {
            const companyId = companySelect.value;
            const processId = processSelect.value; 

            if (!companyId || !processId) {
                resetPLSelect("회사와 공정을 먼저 선택하세요", true);
                return;
            }
            
            resetPLSelect("파트장 목록을 불러오는 중...", true);

            fetch(`${url}?company_id=${companyId}&process_id=${processId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('서버 응답 오류');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    plSelect.innerHTML = ""; 

                    if (data.pls && data.pls.length > 0) {
                        const firstOption = document.createElement("option");
                        firstOption.value = "";
                        firstOption.textContent = "담당 PL님을 선택하세요";
                        plSelect.appendChild(firstOption);

                        data.pls.forEach(pl => {
                            const option = document.createElement("option");
                            option.value = pl.id;
                            option.textContent = pl.name;
                            plSelect.appendChild(option);
                        });
                        plSelect.disabled = false;
                    } else {
                        resetPLSelect("해당 조건의 파트장이 없습니다", true);
                    }
                })
                .catch(error => {
                    console.error('PL 목록 로드 실패:', error);
                    resetPLSelect("오류 발생 (관리자 문의)", true);
                });
        }

        companySelect.addEventListener("change", updatePartLeaders);
        processSelect.addEventListener("change", updatePartLeaders);

        // 초기 실행 (이미 선택된 값이 있을 경우 대비)
        if (companySelect.value && processSelect.value) {
            updatePartLeaders();
        } else {
            resetPLSelect("회사와 공정을 먼저 선택하세요", true);
        }
    });
</script>
{% endblock %}