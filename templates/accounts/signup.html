{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    /* 오류 메시지 (누락 없음) */
    .errorlist {
        color: #dc3545;
        font-weight: bold;
        list-style: none;
        padding-left: 0;
        font-size: 0.9em;
    }
</style>

<div class="container" style="max-width: 600px;">
    <div class="card mt-5 mb-5">
        <div class="card-header">
            <h3 class="text-center">회원가입</h3>
            <p class="text-center text-muted mb-0">가입 후 관리자의 승인을 기다려야 로그인이 가능합니다.</p>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                
                <fieldset>
                    <legend class="fs-5 border-bottom mb-3 pb-2">계정 정보</legend>
                    {{ user_form.as_p }}
                </fieldset>

                <fieldset class="mt-4">
                    <legend class="fs-5 border-bottom mb-3 pb-2">개인 정보</legend>
                    
                    <div class="mb-3">
                        <label for="{{ profile_form.company.id_for_label }}" class="form-label">{{ profile_form.company.label }}</label>
                        {{ profile_form.company.errors }}
                        {{ profile_form.company }}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ profile_form.name.id_for_label }}" class="form-label">{{ profile_form.name.label }}</label>
                        {{ profile_form.name.errors }}
                        <input type="text" name="name" value="{{ profile_form.name.value|default:'' }}" class="form-control" required id="{{ profile_form.name.id_for_label }}">
                    </div>
                    <div class="mb-3">
                        <label for="{{ profile_form.employee_id.id_for_label }}" class="form-label">{{ profile_form.employee_id.label }}</label>
                        {{ profile_form.employee_id.errors }}
                        <input type="text" name="employee_id" value="{{ profile_form.employee_id.value|default:'' }}" class="form-control" required id="{{ profile_form.employee_id.id_for_label }}">
                    </div>
                    <div class="mb-3">
                        <label for="{{ profile_form.class_number.id_for_label }}" class="form-label">{{ profile_form.class_number.label }}</label>
                        {{ profile_form.class_number.errors }}
                        <input type="text" name="class_number" value="{{ profile_form.class_number.value|default:'' }}" class="form-control" required id="{{ profile_form.class_number.id_for_label }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ profile_form.process.id_for_label }}" class="form-label">{{ profile_form.process.label }}</label>
                        {{ profile_form.process.errors }}
                        {{ profile_form.process }}
                    </div>
                    
                    <div id="etch_options_row" style="display: none;" class="mb-3 ps-3 border-start">
                        <label class="form-label">ETCH 상세 공정:</label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="id_etch_tas">
                            <label class="form-check-label" for="id_etch_tas">TAS</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="id_etch_lam">
                            <label class="form-check-label" for="id_etch_lam">LAM</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ profile_form.pl.id_for_label }}" class="form-label">{{ profile_form.pl.label }}</label>
                        {{ profile_form.pl.errors }}
                        {{ profile_form.pl }}
                    </div>

                </fieldset>
                
                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-primary">가입 신청</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="{% static 'accounts/js/public_process_handler.js' %}"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        
        // 1. Django 폼이 생성한 <select> 태그들을 가져옵니다.
        // (Django 폼의 기본 ID는 'id_필드명' 입니다)
        const companySelect = document.getElementById("{{ profile_form.company.id_for_label }}");
        const processSelect = document.getElementById("{{ profile_form.process.id_for_label }}");
        const plSelect = document.getElementById("{{ profile_form.pl.id_for_label }}");

        // 2. AJAX 요청을 보낼 URL을 Django 템플릿 태그로 생성합니다.
        const url = "{% url 'accounts:ajax_load_part_leaders' %}";

        // 3. '파트장' 드롭다운을 초기화하는 함수
        function resetPLSelect(message, disabled) {
            plSelect.innerHTML = ""; // 옵션을 모두 지웁니다.
            const option = document.createElement("option");
            option.value = "";
            option.textContent = message;
            plSelect.appendChild(option);
            plSelect.disabled = disabled; // 비활성화/활성화
        }

        // 4. 파트장 목록을 불러오는 메인 함수
        function updatePartLeaders() {
            const companyId = companySelect.value;
            // process는 ID가 아닌 '이름(name)'을 전송합니다 (forms.py와 맞춤)
            const processId = processSelect.value;

            // 둘 중 하나라도 선택되지 않으면, PL 드롭다운을 초기화하고 비활성화
            if (!companyId || !processId) {
                resetPLSelect("회사와 공정을 먼저 선택하세요", true);
                return;
            }
            
            resetPLSelect("파트장 목록을 불러오는 중...", true);

            // 5. 서버에 Fetch API로 요청
            fetch(`${url}?company_id=${companyId}&process_id=${processId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('서버 응답 오류');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // 성공적으로 데이터를 받으면
                    plSelect.innerHTML = ""; // 기존 옵션 삭제

                    if (data.pls && data.pls.length > 0) {
                        // "선택하세요" 옵션 추가
                        const firstOption = document.createElement("option");
                        firstOption.value = "";
                        firstOption.textContent = "담당 PL님을 선택하세요";
                        plSelect.appendChild(firstOption);

                        // 받아온 PL 목록으로 옵션 채우기
                        data.pls.forEach(pl => {
                            const option = document.createElement("option");
                            option.value = pl.id;
                            option.textContent = pl.name;
                            plSelect.appendChild(option);
                        });
                        plSelect.disabled = false; // 드롭다운 활성화
                    } else {
                        // 해당 조건의 PL이 없는 경우
                        resetPLSelect("해당 조건의 파트장이 없습니다", true);
                    }
                })
                .catch(error => {
                    console.error('PL 목록 로드 실패:', error);
                    resetPLSelect("오류 발생 (관리자 문의)", true);
                });
        }

        // 6. 페이지 로드 시, '회사'와 '공정' 드롭다운에 'change' 이벤트 리스너를 추가
        companySelect.addEventListener("change", updatePartLeaders);
        processSelect.addEventListener("change", updatePartLeaders);

        // 7. 페이지가 처음 로드될 때 '파트장' 드롭다운을 초기 상태로 설정
        // (만약 폼 유효성 검사 실패로 값이 이미 채워져 있다면 초기화하지 않음)
        if (!plSelect.value) {
             resetPLSelect("회사와 공정을 먼저 선택하세요", true);
        }
    });
</script>
{% endblock %}