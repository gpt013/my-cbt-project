{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>ğŸ“‹ ì—‘ì…€ ë³µì‚¬/ë¶™ì—¬ë„£ê¸° ë¬¸ì œ ë“±ë¡</h2>
        <a href="{% url 'quiz:manager_quiz_list' %}" class="btn btn-secondary">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>

    <div class="alert alert-info shadow-sm">
        <h5 class="alert-heading fw-bold"><i class="bi bi-lightbulb-fill"></i> ì‚¬ìš© ë°©ë²•</h5>
        <p class="mb-0">
            ì—‘ì…€ íŒŒì¼ì—ì„œ ë°ì´í„°ë¥¼ ë³µì‚¬(Ctrl+C)í•˜ì—¬ ì•„ë˜ í‘œì˜ ì²« ë²ˆì§¸ ì¹¸ì„ í´ë¦­í•˜ê³  ë¶™ì—¬ë„£ê¸°(Ctrl+V) í•˜ì„¸ìš”.<br>
            ë°ì´í„° ìˆœì„œ: <strong>[ë¬¸ì œë‚´ìš© | ìœ í˜• | ë‚œì´ë„ | íƒœê·¸ | ë³´ê¸°1 | ë³´ê¸°2 | ë³´ê¸°3 | ë³´ê¸°4 | ì •ë‹µ]</strong>
        </p>
    </div>

    <div class="card mb-3 shadow-sm border-0">
        <div class="card-body bg-light">
            <label for="quiz-select" class="form-label fw-bold fs-5 text-primary">
                <i class="bi bi-check2-circle"></i> ë¬¸ì œë¥¼ ì¶”ê°€í•  ì‹œí—˜ ì„ íƒ:
            </label>
            <select id="quiz-select" class="form-select form-select-lg">
                <option value="" selected disabled>-- ì‹œí—˜ì„ ì„ íƒí•˜ì„¸ìš” --</option>
                {% for quiz in quizzes %}
                    <option value="{{ quiz.id }}">
                        [{{ quiz.get_category_display }}] {{ quiz.title }} ({{ quiz.associated_process.name|default:"ê³µí†µ" }})
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div id="excel-grid" style="width: 100%; height: 500px; overflow: hidden; border: 1px solid #ced4da; border-radius: 4px;"></div>
    
    <button id="save-btn" class="btn btn-primary mt-3 btn-lg w-100 fw-bold shadow">
        <i class="bi bi-cloud-upload-fill"></i> ìœ„ ë‚´ìš©ìœ¼ë¡œ ë¬¸ì œ ì¼ê´„ ë“±ë¡í•˜ê¸°
    </button>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" />
<script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>

<script>
    const container = document.getElementById('excel-grid');
    
    // 1. ì´ˆê¸° ë¹ˆ ë°ì´í„° ìƒì„± (30í–‰ x 9ì—´) - ë„‰ë„‰í•˜ê²Œ ìƒì„±
    const initialData = [];
    for (let i = 0; i < 30; i++) {
        // [ë¬¸ì œ, ìœ í˜•, ë‚œì´ë„, íƒœê·¸, ë³´ê¸°1~4, ì •ë‹µ]
        initialData.push(['', 'ê°ê´€ì‹', 'í•˜', '', '', '', '', '', '']); 
    }

    // 2. ê·¸ë¦¬ë“œ ì„¤ì • (Handsontable)
    const hot = new Handsontable(container, {
        data: initialData,
        rowHeaders: true,
        colHeaders: [
            'ë¬¸ì œ ë‚´ìš© (í•„ìˆ˜)', 
            'ìœ í˜• (ì„ íƒ)', 
            'ë‚œì´ë„ (ì„ íƒ)', 
            'íƒœê·¸ (ì‰¼í‘œêµ¬ë¶„)', 
            'ë³´ê¸°1', 'ë³´ê¸°2', 'ë³´ê¸°3', 'ë³´ê¸°4', 
            'ì •ë‹µ (ë²ˆí˜¸ ë˜ëŠ” í…ìŠ¤íŠ¸)'
        ],
        colWidths: [300, 100, 80, 150, 100, 100, 100, 100, 120],
        
        // ê° ì»¬ëŸ¼ì˜ ì†ì„± ì •ì˜
        columns: [
            { type: 'text' }, // 0: ë¬¸ì œ ë‚´ìš©
            { 
                type: 'dropdown', 
                source: ['ê°ê´€ì‹', 'ë‹¤ì¤‘ì„ íƒ', 'ì£¼ê´€ì‹ (ë‹¨ì¼ì •ë‹µ)', 'ì£¼ê´€ì‹ (ë³µìˆ˜ì •ë‹µ)'] 
            }, // 1: ìœ í˜•
            { 
                type: 'dropdown', 
                source: ['ìƒ', 'ì¤‘', 'í•˜'] 
            }, // 2: ë‚œì´ë„
            { type: 'text' }, // 3: íƒœê·¸
            { type: 'text' }, // 4: ë³´ê¸°1
            { type: 'text' }, // 5: ë³´ê¸°2
            { type: 'text' }, // 6: ë³´ê¸°3
            { type: 'text' }, // 7: ë³´ê¸°4
            { type: 'text' }, // 8: ì •ë‹µ
        ],
        
        licenseKey: 'non-commercial-and-evaluation', // ë¬´ë£Œ ë¼ì´ì„ ìŠ¤ í‚¤
        contextMenu: true, // ìš°í´ë¦­ ë©”ë‰´ í—ˆìš© (í–‰ ì¶”ê°€/ì‚­ì œ ë“±)
        minSpareRows: 1,   // ë§¨ ì•„ë˜ ë¹ˆ ì¤„ í•˜ë‚˜ ìë™ ìœ ì§€
        manualColumnResize: true, // ì»¬ëŸ¼ ë„ˆë¹„ ì¡°ì ˆ ê°€ëŠ¥
        className: 'htMiddle', // í…ìŠ¤íŠ¸ ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬
    });

    // 3. ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('save-btn').addEventListener('click', function() {
        const quizId = document.getElementById('quiz-select').value;
        
        // (1) ì‹œí—˜ ì„ íƒ ì—¬ë¶€ ê²€ì‚¬
        if (!quizId) {
            alert('âš ï¸ ë¬¸ì œë¥¼ ì¶”ê°€í•  ì‹œí—˜(Quiz)ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!');
            document.getElementById('quiz-select').focus();
            return;
        }

        // (2) ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ë° ì •ì œ
        const tableData = hot.getData();
        
        // ë¬¸ì œ ë‚´ìš©(ì²« ë²ˆì§¸ ì—´)ì´ ë¹„ì–´ìˆì§€ ì•Šì€ í–‰ë§Œ í•„í„°ë§
        const cleanData = tableData.filter(row => {
            return row[0] !== null && row[0].toString().trim() !== '';
        });

        if (cleanData.length === 0) {
            alert('âš ï¸ ì…ë ¥ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.\ní‘œì˜ ì²« ë²ˆì§¸ ì¹¸(ë¬¸ì œ ë‚´ìš©)ë¶€í„° ë‚´ìš©ì„ ì…ë ¥í•˜ê±°ë‚˜ ì—‘ì…€ì—ì„œ ë³µì‚¬í•´ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.');
            return;
        }

        // (3) ì „ì†¡ í™•ì¸
        if (!confirm(`ì´ ${cleanData.length}ê°œì˜ ë¬¸ì œë¥¼ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            return;
        }

        // (4) ì„œë²„ë¡œ ì „ì†¡ (AJAX)
        // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
        const btn = document.getElementById('save-btn');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ì €ì¥ ì¤‘...';

        fetch("{% url 'quiz:bulk_add_sheet_save' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ 
                'quiz_id': quizId, 
                'data': cleanData 
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`âœ… ì„±ê³µ! ${data.count}ê°œì˜ ë¬¸ì œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                
                // ì„±ê³µ í›„ ì´ë™ ì—¬ë¶€ í™•ì¸
                if(confirm("ë“±ë¡ëœ ë¬¸ì œë¥¼ í™•ì¸í•˜ëŸ¬ ê°€ì‹œê² ìŠµë‹ˆê¹Œ?\n[ì·¨ì†Œ]ë¥¼ ëˆ„ë¥´ë©´ ê³„ì† ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")) {
                    // ë§¤ë‹ˆì € ë¬¸ì œ ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™ (URLì´ ìˆë‹¤ë©´)
                    // ì—¬ê¸°ì„œëŠ” í€´ì¦ˆ ëª©ë¡ìœ¼ë¡œ ì´ë™
                    window.location.href = "{% url 'quiz:manager_quiz_list' %}"; 
                } else {
                    // ê³„ì† ì…ë ¥: ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
                    hot.loadData(initialData); 
                }
            } else {
                alert('âŒ ì˜¤ë¥˜ ë°œìƒ: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .finally(() => {
            // ë²„íŠ¼ ë³µêµ¬
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
    });
</script>
{% endblock %}