{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4" style="max-width: 1000px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold"><i class="bi bi-chat-dots-fill text-primary"></i> ë©´ë‹´ ë° íŠ¹ì´ì‚¬í•­ ê´€ë¦¬</h3>
        <a href="{% url 'quiz:manager_trainee_detail' profile.id %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> ìƒì„¸ í˜ì´ì§€ë¡œ
        </a>
    </div>

    <div class="card shadow-sm border-0 mb-4 bg-light">
        <div class="card-body d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <div class="me-3 text-center">
                    <span class="badge bg-dark mb-1">{{ profile.cohort.name }}</span><br>
                    <span class="badge bg-info text-dark">{{ profile.process.name }}</span>
                </div>
                <div>
                    <h4 class="fw-bold mb-0">{{ profile.name }} <span class="text-muted fs-6">({{ profile.employee_id }})</span></h4>
                    <div class="mt-1">
                        í˜„ì¬ ìƒíƒœ: 
                        {% if profile.status == 'counseling' %}
                            <span class="badge bg-danger">ğŸ”´ ë©´ë‹´ í•„ìš” (ì‹œí—˜ ì ê¸ˆ)</span>
                        {% elif profile.status == 'attending' %}
                            <span class="badge bg-success">ğŸŸ¢ ì¬ì§ ì¤‘ (ì •ìƒ)</span>
                        {% elif profile.status == 'dropout' %}
                            <span class="badge bg-dark">âš« í‡´ì†Œ</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ profile.get_status_display }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="text-end">
                <small class="text-muted d-block">ìµœê·¼ ì ‘ì†: {{ profile.user.last_login|date:"Y-m-d H:i"|default:"-" }}</small>
                <small class="text-muted">ê°€ì…ì¼: {{ profile.user.date_joined|date:"Y-m-d" }}</small>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-7">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold"><i class="bi bi-journal-text"></i> ë©´ë‹´ ê¸°ë¡ ì¼ì§€</h5>
                <span class="badge bg-secondary rounded-pill">{{ interviews.count }}ê±´</span>
            </div>

            {% if interviews %}
                <div class="vstack gap-3">
                    {% for iv in interviews %}
                    <div class="card shadow-sm border-0 border-start border-4 {% if iv.is_passed %}border-success{% else %}border-warning{% endif %}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="badge bg-secondary">{{ iv.get_stage_display }}</span>
                                <small class="text-muted">
                                    <i class="bi bi-clock"></i> {{ iv.created_at|date:"Y-m-d H:i" }} 
                                    by <strong>{{ iv.interviewer.profile.name|default:iv.interviewer.username }}</strong>
                                </small>
                            </div>
                            
                            <div class="bg-light p-3 rounded mb-2">
                                <strong>ë‚´ìš©:</strong> {{ iv.content|linebreaksbr }}
                            </div>
                            
                            {% if iv.opinion %}
                            <p class="card-text text-secondary small mb-2 ps-2 border-start border-3">
                                ğŸ’¡ ì˜ê²¬: {{ iv.opinion }}
                            </p>
                            {% endif %}
                            
                            <div class="text-end mt-2">
                                {% if iv.is_passed %}
                                    <span class="badge bg-success-subtle text-success border border-success">
                                        <i class="bi bi-check-circle-fill"></i> ì¡°ì¹˜ ì™„ë£Œ (í†µê³¼)
                                    </span>
                                {% else %}
                                    <span class="badge bg-warning-subtle text-warning border border-warning">
                                        <i class="bi bi-hourglass-split"></i> ë¯¸í•´ê²° (ê¸°ë¡ë§Œ ë¨)
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-light border text-center py-5">
                    <i class="bi bi-clipboard-x fs-1 text-muted"></i>
                    <p class="mt-3 text-muted">ì•„ì§ ë“±ë¡ëœ ë©´ë‹´ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            {% endif %}
        </div>

        <div class="col-md-5">
            <div class="card shadow border-0 sticky-top" style="top: 20px; z-index: 10;">
                <div class="card-header bg-primary text-white fw-bold">
                    <i class="bi bi-pencil-square"></i> ìƒˆ ê¸°ë¡ ì‘ì„±
                </div>
                <div class="card-body">
                    {% if next_stage %}
                        <form method="post">
                            {% csrf_token %}
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold">í˜„ì¬ ì§„í–‰ ë‹¨ê³„</label>
                                <input type="text" class="form-control bg-light" value="{{ next_stage }}ì°¨ ë©´ë‹´ ì§„í–‰ ì¤‘" disabled>
                                <input type="hidden" name="stage" value="{{ next_stage }}">
                                <div class="form-text text-primary">
                                    * ì´ì „ ì°¨ìˆ˜ê°€ ì™„ë£Œë˜ì–´ì•¼ ë‹¤ìŒ ì°¨ìˆ˜ê°€ í™œì„±í™”ë©ë‹ˆë‹¤.
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">ë©´ë‹´ ë‚´ìš© <span class="text-danger">*</span></label>
                                <textarea name="content" class="form-control" rows="4" required placeholder="ë©´ë‹´ ì‚¬ìœ  ë° ì£¼ìš” ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">ì¡°ì¹˜ ì˜ê²¬</label>
                                <input type="text" name="opinion" class="form-control" placeholder="ì˜ˆ: í•™ìŠµ íƒœë„ ê°œì„  ì•½ì†í•¨, ê²½ê³  ì¡°ì¹˜ ë“±">
                            </div>

                            <hr>

                            <div class="mb-3 form-check p-3 bg-light border rounded">
                                <input type="checkbox" class="form-check-input" id="passCheck" name="is_passed">
                                <label class="form-check-label fw-bold text-danger" for="passCheck">
                                    âœ… ì´ ë‹¨ê³„ í†µê³¼ ë° ì ê¸ˆ í•´ì œ
                                </label>
                                <div class="form-text mt-2" style="font-size: 0.85em;">
                                    ì²´í¬ í›„ ì €ì¥í•˜ë©´ êµìœ¡ìƒ ìƒíƒœê°€ <strong>'ì¬ì§'</strong>ìœ¼ë¡œ ë³€ê²½ë˜ì–´ ì¦‰ì‹œ ì‹œí—˜ ì‘ì‹œê°€ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.<br>
                                    (ë‹¨, 3ì°¨ ë©´ë‹´ì¸ ê²½ìš° <strong>'í‡´ì†Œ'</strong> ì²˜ë¦¬ë©ë‹ˆë‹¤.)
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary w-100 fw-bold py-2">
                                <i class="bi bi-save"></i> ì €ì¥ ë° ì ìš©
                            </button>
                        </form>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-check-circle-fill fs-1 text-success"></i>
                            <h5 class="mt-3 fw-bold">ëª¨ë“  ë©´ë‹´ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</h5>
                            <p class="text-muted">ë” ì´ìƒ ì§„í–‰í•  ë©´ë‹´ ë‹¨ê³„ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}