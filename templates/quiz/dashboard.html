{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <h1 class="mt-4 mb-4 fw-bold">ğŸ“Š í†µí•© ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>

    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
            <strong>ğŸ” ë°ì´í„° í•„í„°ë§</strong> (ì›í•˜ëŠ” ì¡°ê±´ë§Œ ì„ íƒí•˜ì—¬ ë¶„ì„)
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-2">
                    <label class="form-label small fw-bold">ê¸°ìˆ˜</label>
                    <select name="cohort" class="form-select form-select-sm">
                        <option value="">ì „ì²´ ê¸°ìˆ˜</option>
                        {% for c in cohorts %}
                            <option value="{{ c.id }}" {% if sel_cohort == c.id %}selected{% endif %}>{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold">íšŒì‚¬</label>
                    <select name="company" class="form-select form-select-sm">
                        <option value="">ì „ì²´ íšŒì‚¬</option>
                        {% for c in companies %}
                            <option value="{{ c.id }}" {% if sel_company == c.id %}selected{% endif %}>{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold">ê³µì •</label>
                    <select name="process" class="form-select form-select-sm">
                        <option value="">ì „ì²´ ê³µì •</option>
                        {% for p in processes %}
                            <option value="{{ p.id }}" {% if sel_process == p.id %}selected{% endif %}>{{ p.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-primary">ğŸ‘¤ êµìœ¡ìƒ (ê°œë³„ ë¶„ì„)</label>
                    <select name="student" class="form-select form-select-sm border-primary">
                        <option value="">ì „ì²´ êµìœ¡ìƒ ë³´ê¸°</option>
                        {% for p in all_profiles %}
                            <option value="{{ p.id }}" {% if sel_student == p.id %}selected{% endif %}>
                                [{{ p.cohort.name|default:"-" }}] {{ p.name }} ({{ p.user.username }})
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label small fw-bold">í€´ì¦ˆ ì¢…ë¥˜</label>
                    <select name="quiz" class="form-select form-select-sm">
                        <option value="">ì „ì²´ í€´ì¦ˆ</option>
                        {% for q in quizzes %}
                            <option value="{{ q.id }}" {% if sel_quiz == q.id %}selected{% endif %}>{{ q.title }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-12 text-end">
                    <a href="{% url 'quiz:dashboard' %}" class="btn btn-secondary btn-sm me-2">ì´ˆê¸°í™”</a>
                    <button type="submit" class="btn btn-primary btn-sm">ğŸ“Š ë¶„ì„ ì ìš©</button>
                </div>
            </form>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card bg-primary text-white h-100">
                <div class="card-body">
                    <h6 class="text-uppercase">ë¶„ì„ ëŒ€ìƒ ì¸ì›</h6>
                    <h2 class="display-4 fw-bold">{{ total_students }}ëª…</h2>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    <h6 class="text-uppercase">í‰ê·  ì ìˆ˜</h6>
                    <h2 class="display-4 fw-bold">{{ average_score }}ì </h2>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-info text-white h-100">
                <div class="card-body">
                    <h6 class="text-uppercase">í•©ê²©ë¥ </h6>
                    <h2 class="display-4 fw-bold">{{ pass_rate }}%</h2>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-warning text-dark h-100">
                <div class="card-body">
                    <h6 class="text-uppercase">ì´ ì‘ì‹œ íšŸìˆ˜</h6>
                    <h2 class="display-4 fw-bold">{{ total_attempts }}íšŒ</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header">
                    <i class="bi bi-bar-chart-fill"></i> í€´ì¦ˆë³„ í‰ê·  ì ìˆ˜
                </div>
                <div class="card-body">
                    <div style="height: 300px;">
                        <canvas id="quizChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100 border-danger">
                <div class="card-header bg-danger text-white">
                    <i class="bi bi-exclamation-triangle-fill"></i> 
                    {% if sel_student %} ì„ íƒëœ êµìœ¡ìƒ ì •ë³´ {% else %} ì§‘ì¤‘ ê´€ë¦¬ í•„ìš” êµìœ¡ìƒ {% endif %}
                </div>
                <div class="card-body">
                    <p class="text-muted small">* ê¸°ì¤€: í‰ê·  60ì  ë¯¸ë§Œ ë˜ëŠ” 2íšŒ ì´ìƒ ë¶ˆí•©ê²©ì</p>
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>ì´ë¦„</th>
                                    <th>ê¸°ìˆ˜</th>
                                    <th>ê³µì •</th>
                                    <th>í‰ê· </th>
                                    <th>ë¶ˆí•©ê²©</th>
                                    <th>ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in at_risk_students %}
                                <tr>
                                    <td>{{ student.name }}</td>
                                    <td>{{ student.cohort }}</td>
                                    <td>{{ student.process }}</td>
                                    <td class="text-danger fw-bold">{{ student.avg_score }}</td>
                                    <td>{{ student.fail_count }}íšŒ</td>
                                    <td>
                                        {% if student.profile_id %}
                                        <a href="{% url 'quiz:evaluate_trainee' student.profile_id %}" class="btn btn-sm btn-outline-secondary">í‰ê°€/ë©´ë‹´</a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-3">
                                        {% if sel_student %}
                                            ì•„ì§ ì‹œí—˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
                                        {% else %}
                                            ìœ„í—˜êµ° êµìœ¡ìƒì´ ì—†ìŠµë‹ˆë‹¤. ğŸ‘
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-x-circle-fill text-danger"></i> ì‹¬ì¸µ ì˜¤ë‹µ ë¶„ì„ (ì˜¤ë‹µë¥  ìˆœ)</span>
            <span class="badge bg-secondary">{{ incorrect_analysis|length }}ê°œ ë¬¸ì œ</span>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table align-middle table-hover" id="incorrectTable">
                    <thead class="table-light">
                        <tr>
                            <th>ìˆœìœ„</th>
                            <th style="width: 40%;">ë¬¸ì œ ë‚´ìš©</th>
                            <th>ë‚œì´ë„</th>
                            <th class="text-center">ì˜¤ë‹µ íšŸìˆ˜</th>
                            <th class="text-center">ì˜¤ë‹µë¥ </th>
                            <th class="text-center">ë¶„ì„</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in incorrect_analysis %}
                        <tr class="incorrect-row {% if forloop.counter > 5 %}d-none{% endif %}">
                            <td>{{ forloop.counter }}</td>
                            <td>
                                <small class="text-muted">[{{ item.quiz_title }}]</small><br>
                                {{ item.question_text|truncatechars:50 }}
                            </td>
                            <td>
                                <span class="badge {% if item.difficulty == 'ìƒ' %}bg-danger{% elif item.difficulty == 'ì¤‘' %}bg-warning text-dark{% else %}bg-success{% endif %}">
                                    {{ item.difficulty }}
                                </span>
                            </td>
                            <td class="text-center">
                                {{ item.wrong }} / {{ item.total }}
                            </td>
                            <td class="text-center">
    <div class="progress" style="height: 20px;">
        <div class="progress-bar bg-danger" role="progressbar" style="width: {{ item.rate }}%;" 
             aria-valuenow="{{ item.rate }}" aria-valuemin="0" aria-valuemax="100">
            {{ item.rate }}%
        </div>
    </div>

    {% if item.difficulty == 'í•˜' and item.rate > 50 %}
        <div class="mt-1">
            <span class="badge bg-secondary text-wrap" style="font-size:0.7em;">
                âš ï¸ ë‚œì´ë„ ìƒí–¥ ì¶”ì²œ
            </span>
        </div>
    {% endif %}

    {% if item.difficulty == 'ìƒ' and item.rate < 30 %}
        <div class="mt-1">
            <span class="badge bg-info text-dark text-wrap" style="font-size:0.7em;">
                â¬‡ï¸ ë‚œì´ë„ í•˜í–¥ ì¶”ì²œ
            </span>
        </div>
    {% endif %}
</td>
                            <td class="text-center">
                                <button type="button" class="btn btn-sm btn-outline-primary analysis-btn" 
                                        data-index="{{ forloop.counter0 }}">
                                    <i class="bi bi-search"></i> ìƒì„¸
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-4">ë¶„ì„í•  ì˜¤ë‹µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            {% if incorrect_analysis|length > 5 %}
            <div class="d-grid gap-2 mt-3">
                <button class="btn btn-outline-secondary" type="button" id="loadMoreBtn">
                    ğŸ‘‡ ë”ë³´ê¸° (ë‚˜ë¨¸ì§€ ë¬¸ì œ í¼ì¹˜ê¸°)
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="modal fade" id="analysisModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">ë¬¸ì œ ë¶„ì„</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="modalQuestionText" class="fw-bold mb-3"></p>
                
                <div id="correctAnswerBox" class="alert mb-3 text-center text-white fw-bold" style="background-color: #6c757d;">
                    <i class="bi bi-check-circle-fill"></i> 
                    ì •ë‹µ: <span id="modalCorrectAnswer"></span>
                </div>

                <div style="height: 300px; position: relative;">
                    <canvas id="analysisChart"></canvas>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

{{ incorrect_analysis|json_script:"analysis-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // [ìƒ‰ìƒ íŒ”ë ˆíŠ¸]
        const correctColor = '#4BC0C0'; // ì •ë‹µ (ì²­ë¡ìƒ‰)
        const incorrectColors = [       // ì˜¤ë‹µ (ë‹¤ì–‘í•œ ìƒ‰ìƒ ìˆœí™˜)
            '#FF6384', '#FF9F40', '#FFCE56', '#9966FF', '#C9CBCF', '#36A2EB'
        ];

        // 1. í€´ì¦ˆë³„ í‰ê·  ì ìˆ˜ ì°¨íŠ¸
        const ctx = document.getElementById('quizChart');
        if (ctx) {
            new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: {{ chart_labels|safe }},
                    datasets: [{
                        label: 'í‰ê·  ì ìˆ˜',
                        data: {{ chart_data|safe }},
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });
        }

        // 2. ë”ë³´ê¸° ë²„íŠ¼
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        if (loadMoreBtn) {
            loadMoreBtn.addEventListener('click', function() {
                document.querySelectorAll('.incorrect-row.d-none').forEach(row => {
                    row.classList.remove('d-none');
                });
                this.style.display = 'none';
            });
        }

        // 3. ìƒì„¸ ë¶„ì„ ëª¨ë‹¬ (ìƒ‰ìƒ ì¼ì¹˜ ê¸°ëŠ¥ í¬í•¨)
        let analysisChartInstance = null;
        const analysisModalEl = document.getElementById('analysisModal');
        let analysisModal = null;
        if (analysisModalEl) {
            try {
                analysisModal = new bootstrap.Modal(analysisModalEl);
            } catch (e) {
                console.error("Modal Init Error:", e);
            }
        }

        const analysisData = JSON.parse(document.getElementById('analysis-data').textContent);

        document.querySelectorAll('.analysis-btn').forEach(button => {
            button.addEventListener('click', function() {
                const index = this.dataset.index; 
                const item = analysisData[index]; 

                if (!item) return;

                let labels, data, correctList;
                try {
                    labels = JSON.parse(item.dist_labels);
                    data = JSON.parse(item.dist_counts);
                    // ì •ë‹µ ë¦¬ìŠ¤íŠ¸ íŒŒì‹± (ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´)
                    correctList = item.correct_list ? JSON.parse(item.correct_list) : [];
                } catch (e) {
                    console.error("Data Parse Error:", e);
                    return;
                }

                if (analysisModal) analysisModal.show();

                document.getElementById('modalTitle').innerText = `ì˜¤ë‹µ ë¶„ì„ (ìˆœìœ„: ${parseInt(index) + 1}ìœ„)`;
                document.getElementById('modalQuestionText').innerText = item.question_text;
                
                const correctAnswerText = item.correct_answer ? item.correct_answer : "ì •ë‹µ ì •ë³´ ì—†ìŒ";
                
                // ì •ë‹µ ë°•ìŠ¤ í‘œì‹œ (ë°°ê²½ìƒ‰ì€ ì´ˆë¡ìƒ‰ ê³ ì •)
                const answerBox = document.getElementById('correctAnswerBox');
                answerBox.querySelector('span').innerText = correctAnswerText;
                answerBox.style.backgroundColor = correctColor; 

                // [í•µì‹¬] ì°¨íŠ¸ ìƒ‰ìƒ ë°°ì—´ ìƒì„± ë¡œì§
                let incorrectColorIndex = 0;
                const backgroundColors = labels.map(label => {
                    // ë¼ë²¨ì´ ì •ë‹µ ë¦¬ìŠ¤íŠ¸ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (ê³µë°± ì œê±° í›„ ë¹„êµ)
                    const isCorrect = correctList.some(correct => correct.trim() === label.trim());
                    
                    if (isCorrect) {
                        return correctColor; // ì •ë‹µì´ë©´ ì²­ë¡ìƒ‰
                    } else {
                        // ì˜¤ë‹µì´ë©´ íŒ”ë ˆíŠ¸ ìˆœí™˜
                        const color = incorrectColors[incorrectColorIndex % incorrectColors.length];
                        incorrectColorIndex++;
                        return color;
                    }
                });

                if (analysisChartInstance) {
                    analysisChartInstance.destroy();
                }

                const ctx2 = document.getElementById('analysisChart').getContext('2d');
                analysisChartInstance = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors, // [ì ìš©] ê³„ì‚°ëœ ìƒ‰ìƒ ë°°ì—´
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: { display: true, text: 'ë‹µë³€ ì„ íƒ ë¶„í¬ (ëª…)' }
                        }
                    }
                });
            });
        });
    });
</script>
{% endblock %}