{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid mt-4 pb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold"><i class="bi bi-file-earmark-person-fill text-success"></i> ìµœì¢… í‰ê°€ì„œ ì‘ì„±</h2>
        <a href="{% url 'quiz:manager_trainee_detail' trainee.id %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> ì·¨ì†Œ ë° ëŒì•„ê°€ê¸°
        </a>
    </div>

    <form method="post">
        {% csrf_token %}
        <div class="row">
            <div class="col-lg-4">
                <div class="card shadow-sm border-0 mb-3 sticky-top" style="top: 20px; z-index: 1;">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">ëŒ€ìƒì ì •ë³´</h5>
                        <span class="badge bg-light text-dark">{{ trainee.process.name }}</span>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <h3 class="fw-bold">{{ trainee.name }}</h3>
                            <p class="text-muted mb-0">{{ trainee.employee_id }} | {{ trainee.cohort.name }}</p>
                            <span class="badge {% if trainee.status == 'attending' %}bg-success{% else %}bg-danger{% endif %}">
                                {{ trainee.get_status_display }}
                            </span>
                        </div>

                        <h6 class="fw-bold text-secondary border-bottom pb-1"><i class="bi bi-graph-up"></i> ì‹œí—˜ ì„±ì </h6>
                        <ul class="list-group list-group-flush mb-3 small">
                            <li class="list-group-item d-flex justify-content-between">
                                <span>í‰ê·  ì ìˆ˜</span> <span class="fw-bold">{{ avg_score }}ì </span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>ì¬ì‹œí—˜/ë¶ˆí•©ê²©</span> <span class="text-danger">{{ fail_count }}íšŒ</span>
                            </li>
                        </ul>

                        <h6 class="fw-bold text-secondary border-bottom pb-1"><i class="bi bi-journal-medical"></i> íŠ¹ì´ì‚¬í•­ & ê²½ê³ </h6>
                        <div class="mb-3" style="max-height: 200px; overflow-y: auto;">
                            {% for log in logs %}
                                <div class="p-2 border-bottom small">
                                    <span class="badge bg-secondary">{{ log.get_log_type_display }}</span>
                                    <span class="text-muted" style="font-size:0.8em;">{{ log.created_at|date:"m-d" }}</span>
                                    <div class="text-truncate">{{ log.reason }}</div>
                                </div>
                            {% empty %}
                                <p class="text-muted small text-center py-2">ê¸°ë¡ëœ íŠ¹ì´ì‚¬í•­ ì—†ìŒ</p>
                            {% endfor %}
                        </div>

                        <h6 class="fw-bold text-secondary border-bottom pb-1"><i class="bi bi-calendar-check"></i> ê·¼íƒœ í˜„í™©</h6>
                         <div class="d-flex flex-wrap gap-1 mt-2">
                            {% for stat in attendance_stats %}
                                <span class="badge bg-light text-dark border">
                                    {{ stat.work_type__name }}: {{ stat.count }}
                                </span>
                            {% empty %}
                                <span class="text-muted small">ë°ì´í„° ì—†ìŒ</span>
                            {% endfor %}
                         </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-white fw-bold text-primary">
                        ğŸ“Š ì •ëŸ‰ í‰ê°€ ì ìˆ˜ ì…ë ¥
                    </div>
                    <div class="card-body bg-light">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label fw-bold">ì‹œí—˜ í‰ê·  (40%)</label>
                                <input type="text" class="form-control" value="{{ final_assessment.exam_avg_score }}" disabled readonly>
                                <div class="form-text">ìë™ ì‚°ì¶œ</div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">ì‹¤ìŠµ ì ìˆ˜ (30%)</label>
                                <input type="number" name="practice_score" class="form-control" step="0.1" min="0" max="100" 
                                       value="{{ final_assessment.practice_score }}" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">ë…¸íŠ¸ ì ìˆ˜ (15%)</label>
                                <input type="number" name="note_score" class="form-control" step="0.1" min="0" max="100" 
                                       value="{{ final_assessment.note_score }}" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">íƒœë„ ì ìˆ˜ (15%)</label>
                                <input type="number" name="attitude_score" class="form-control" step="0.1" min="0" max="100" 
                                       value="{{ final_assessment.attitude_score }}" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-white fw-bold text-success">
                        âœ… íƒœë„ ë° ì—­ëŸ‰ ì²´í¬ë¦¬ìŠ¤íŠ¸
                    </div>
                    <div class="card-body">
                        {% for category in categories %}
                        <div class="mb-4">
                            <h5 class="fw-bold border-bottom pb-2 mb-3">
                                <span class="badge bg-success me-2">{{ forloop.counter }}</span> {{ category.name }}
                            </h5>
                            <div class="row g-2">
                                {% for item in category.evaluationitem_set.all %}
                                <div class="col-md-6">
                                    <div class="form-check p-3 border rounded bg-white h-100 hover-shadow cursor-pointer" onclick="document.getElementById('item_{{ item.id }}').click();">
                                        <input class="form-check-input" type="checkbox" name="selected_items" value="{{ item.id }}" id="item_{{ item.id }}"
                                            {% if item in form.instance.selected_items.all %}checked{% endif %} onclick="event.stopPropagation();">
                                        <label class="form-check-label w-100 ps-2" for="item_{{ item.id }}" style="cursor: pointer;">
                                            <span class="{% if not item.is_positive %}text-danger fw-bold{% else %}text-dark{% endif %}">
                                                {{ item.description }}
                                            </span>
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-white fw-bold">
                        ğŸ’¬ ë§¤ë‹ˆì € ì¢…í•© ì˜ê²¬
                    </div>
                    <div class="card-body">
                        {{ form.overall_comment }}
                        <div class="form-text text-muted mt-2">
                            * êµìœ¡ìƒì˜ ê°•ì , ë³´ì™„ì , í–¥í›„ ì§€ë„ ë°©í–¥ ë“±ì„ ììœ ë¡­ê²Œ ê¸°ìˆ í•´ì£¼ì„¸ìš”. ì´ ë‚´ìš©ì€ ìµœì¢… ë¦¬í¬íŠ¸ì— ì¶œë ¥ë©ë‹ˆë‹¤.
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 mb-5">
                    <button type="submit" class="btn btn-primary btn-lg fw-bold py-3 shadow">
                        <i class="bi bi-save"></i> í‰ê°€ ì €ì¥ ë° ì™„ë£Œ
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
    .hover-shadow:hover {
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
        transform: translateY(-2px);
        transition: 0.3s;
        border-color: #0d6efd !important;
    }
    .cursor-pointer { cursor: pointer; }
</style>
{% endblock %}