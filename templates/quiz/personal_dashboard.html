{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            <h1>ë‚˜ì˜ í•™ìŠµ ëŒ€ì‹œë³´ë“œ</h1>
        </div>
        <div class="card-body p-4">
            <h4>ë‚˜ì˜ í•™ìŠµ ìš”ì•½</h4>
            <div class="row mt-3">
                <div class="col-md-6 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body d-flex flex-column justify-content-center">
                            <h5 class="card-title">ì´ ì‘ì‹œ íšŸìˆ˜</h5>
                            <p class="card-text fs-2 fw-bold mb-0">{{ total_attempts }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body d-flex flex-column justify-content-center">
                            <h5 class="card-title">ì „ì²´ í‰ê·  ì ìˆ˜</h5>
                            <p class="card-text fs-2 fw-bold mb-0">{{ overall_average_score|floatformat:1|default:"N/A" }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <hr class="my-4">

            <div class="row">
                <div class="col-lg-6 mb-4">
                    <h4 class="text-center">ê³¼ëª©ë³„ 1ì°¨ ì ìˆ˜</h4>
                    <div>
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <h4 class="text-center">ê³¼ëª©ë³„ ì „ì²´ í‰ê· </h4>
                    <div>
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
            </div>

            <hr class="my-4">

            <h4>ìƒì„¸ ì„±ì í‘œ</h4>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th scope="col">ì‹œí—˜ ì¢…ë¥˜</th>
                            <th scope="col" class="text-center">1ì°¨ ì ìˆ˜</th>
                            <th scope="col" class="text-center">ìµœê³  ì ìˆ˜</th>
                            <th scope="col" class="text-center">ì „ì²´ í‰ê· </th>
                            <th scope="col" class="text-center">ì‘ì‹œ íšŸìˆ˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for summary in summary_data %}
                        <tr>
                            <td><strong>{{ summary.title }}</strong></td>
                            <td class="text-center">{{ summary.first_score|floatformat:0|default:"-" }}ì </td>
                            <td class="text-center">{{ summary.max_score|floatformat:0|default:"-" }}ì </td>
                            <td class="text-center">{{ summary.avg_score|floatformat:1|default:"-" }}ì </td>
                            <td class="text-center">{{ summary.attempts }}íšŒ</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <hr class="my-4">
            
            <h4>ë‚˜ì˜ ë±ƒì§€</h4>
            <div class="row">
                {% for badge in user_badges %}
                    <div class="col-md-4 col-lg-3 mb-3 text-center">
                        <div class="card h-100">
                            {% if badge.image %}
                                <img src="{{ badge.image.url }}" class="card-img-top p-3" alt="{{ badge.name }}" style="max-height: 150px; object-fit: contain;">
                            {% else %}
                                <div class="p-3 fs-1">ğŸ†</div>
                            {% endif %}
                            <div class="card-body">
                                <h6 class="card-title">{{ badge.name }}</h6>
                                <p class="card-text small text-muted">{{ badge.description }}</p>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <p class="text-muted">ì•„ì§ íšë“í•œ ë±ƒì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ì‹œí—˜ì— ë„ì „í•´ë³´ì„¸ìš”!</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{{ summary_data|json_script:"summary-data" }}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        const summaryDataElement = document.getElementById('summary-data');
        if (!summaryDataElement) return;

        const summaryData = JSON.parse(summaryDataElement.textContent);
        if (summaryData.length === 0) return;

        const radarCtx = document.getElementById('radarChart');
        const barCtx = document.getElementById('barChart');

        // null ì²´í¬ë¥¼ ì¶”ê°€í•˜ì—¬ ë°ì´í„°ê°€ ì—†ì„ ë•Œ 0ìœ¼ë¡œ ì²˜ë¦¬
        const labels = summaryData.map(item => item.title);
        const firstScoreData = summaryData.map(item => item.first_score || 0);
        const avgScoreData = summaryData.map(item => item.avg_score || 0);

        // 1. ë°©ì‚¬í˜• ì°¨íŠ¸ (1ì°¨ ì ìˆ˜)
        if (radarCtx) {
            new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '1ì°¨ ì ìˆ˜',
                        data: firstScoreData,
                        fill: true,
                        backgroundColor: 'rgba(25, 135, 84, 0.2)',
                        borderColor: 'rgb(25, 135, 84)',
                        pointBackgroundColor: 'rgb(25, 135, 84)',
                    }]
                },
                options: { 
                    scales: { 
                        r: { 
                            angleLines: { display: true },
                            suggestedMin: 0,
                            suggestedMax: 100,
                            pointLabels: { font: { size: 14 } }
                        } 
                    }, 
                    plugins: { 
                        legend: { display: false } 
                    } 
                }
            });
        }

        // 2. ë§‰ëŒ€ê·¸ë˜í”„ (ì „ì²´ í‰ê· )
        if (barCtx) {
            new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì „ì²´ í‰ê·  ì ìˆ˜',
                        data: avgScoreData,
                        backgroundColor: 'rgba(13, 110, 253, 0.5)',
                        borderColor: 'rgb(13, 110, 253)',
                        borderWidth: 1
                    }]
                },
                options: { 
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            max: 100 
                        } 
                    }, 
                    plugins: { 
                        legend: { display: false } 
                    } 
                }
            });
        }
    });
</script>
{% endblock %}