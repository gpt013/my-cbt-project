{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    /* [ì‹ í˜¸ë“± Stepper ìŠ¤íƒ€ì¼] */
    .step-container { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; }
    .step-item { display: flex; align-items: center; opacity: 0.8; padding: 3px 8px; border-radius: 6px; background-color: #f8f9fa; border: 1px solid #dee2e6; transition: all 0.2s; }
    .step-item.active { opacity: 1; font-weight: bold; background-color: #fff; border-color: #adb5bd; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    
    /* ì‹ í˜¸ë“± ì  ìƒ‰ìƒ ì •ì˜ */
    .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
    .dot-gray { background-color: #e9ecef; border: 1px solid #ced4da; } /* ëŒ€ê¸° */
    .dot-red  { background-color: #dc3545; }   /* ìœ„í—˜/ì‘ì„±í•„ìš” */
    .dot-blue { background-color: #0d6efd; }   /* ì‘ì„±ì™„ë£Œ/í™•ì¸ */
    .dot-green{ background-color: #198754; }   /* í•©ê²© */
    .dot-black{ background-color: #212529; }   /* í‡´ì†Œ */

    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë¯¸ì„¸ ì¡°ì • */
    .btn-xs { padding: 1px 6px; font-size: 0.7rem; margin-left: 4px; border-radius: 4px; }
</style>

<div class="container-fluid mt-4 pb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold"><i class="bi bi-person-vcard-fill text-primary"></i> êµìœ¡ìƒ ìƒì„¸ ì •ë³´</h3>
        <a href="#" onclick="history.back()" class="btn btn-outline-secondary">
            <i class="bi bi-list"></i> ëª©ë¡ìœ¼ë¡œ
        </a>
    </div>

    <div class="row g-4">
        <div class="col-lg-4 col-xl-3">
            <div class="card shadow-sm border-0 sticky-top" style="top: 20px; z-index: 1;">
                <div class="card-body text-center pt-4">
                    <div class="mb-3 position-relative d-inline-block">
                        <i class="bi bi-person-circle display-1 text-secondary"></i>
                        {% if profile.status == 'counseling' %}
                            <span class="position-absolute top-0 start-100 translate-middle p-2 bg-danger border border-light rounded-circle"></span>
                        {% endif %}
                    </div>
                    <h4 class="fw-bold mb-0">{{ profile.name }}</h4>
                    <p class="text-muted mb-3">{{ profile.employee_id }}</p>
                    
                    <div class="d-flex justify-content-center gap-2 mb-4">
                        <span class="badge bg-dark">{{ profile.cohort.name|default:"ê¸°ìˆ˜ì—†ìŒ" }}</span>
                        <span class="badge bg-info text-dark">{{ profile.process.name|default:"ê³µì •ì—†ìŒ" }}</span>
                    </div>

                    <div class="d-grid gap-2 mb-4">
                        {% if profile.status == 'attending' %}
                            <button class="btn btn-success fw-bold" disabled>ğŸŸ¢ ì •ìƒ ì¬ì§ ì¤‘</button>
                        {% elif profile.status == 'counseling' %}
                            <button class="btn btn-danger fw-bold">ğŸ”´ ë©´ë‹´ í•„ìš” (ê´€ë¦¬)</button>
                        {% elif profile.status == 'dropout' %}
                            <button class="btn btn-dark fw-bold" disabled>âš« í‡´ì†Œ</button>
                        {% endif %}
                    </div>

                    <div class="bg-light p-3 rounded text-start mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold small">ëˆ„ì  ê²½ê³ </span>
                            <span class="badge bg-danger rounded-pill">{{ profile.warning_count }}íšŒ</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-danger" role="progressbar" style="width: {% widthratio profile.warning_count 4 100 %}%"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-1" style="font-size: 0.7em; color: #aaa;">
                            <span>0</span><span>2(ê²½ê³ ì¥)</span><span>4(í‡´ì†Œ)</span>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <a href="{% url 'quiz:evaluate_trainee' profile.id %}" class="btn btn-outline-primary fw-bold">
                            <i class="bi bi-clipboard-check"></i> ìµœì¢… í‰ê°€ì„œ ì‘ì„±
                        </a>
                        <a href="{% url 'quiz:manage_student_logs' profile.id %}" class="btn btn-outline-danger fw-bold">
                            <i class="bi bi-exclamation-triangle"></i> íŠ¹ì´ì‚¬í•­/ê²½ê³  ë“±ë¡
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8 col-xl-9">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white border-bottom-0 pt-3 ps-3">
                    <ul class="nav nav-tabs card-header-tabs" id="detailTab" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active fw-bold" data-bs-toggle="tab" data-bs-target="#tab-results">ğŸ“ ì‹œí—˜ ì„±ì </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#tab-logs">ğŸš¨ íŠ¹ì´ì‚¬í•­/ë©´ë‹´ ë¡œê·¸</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#tab-badges">ğŸ… ë±ƒì§€</button>
                        </li>
                    </ul>
                </div>

                <div class="card-body bg-light">
                    <div class="tab-content">
                        
                        <div class="tab-pane fade show active" id="tab-results">
                            <div class="bg-white rounded border p-3">
                                <h5 class="fw-bold mb-3">ì‹œí—˜ ì‘ì‹œ ì´ë ¥ ë° í”„ë¡œì„¸ìŠ¤</h5>
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th>ì‹œí—˜ëª…</th>
                                                <th>ì ìˆ˜</th>
                                                <th>ê²°ê³¼</th>
                                                <th style="min-width: 380px;">ì§„í–‰ ë‹¨ê³„ (Process)</th>
                                                <th>ì‘ì‹œì¼</th>
                                            </tr>
                                        </thead>
                                        <tbody>
    {% for r in results %}
    <tr>
        <td class="fw-bold">{{ r.quiz.title }}</td>
        
        <td class="text-center">
            <span class="{% if r.is_pass %}text-success{% else %}text-danger{% endif %} fw-bold">
                {{ r.score }}ì 
            </span>
        </td>

        <td class="text-center">
            {% if r.is_pass %}
                <span class="badge bg-success">í•©ê²©</span>
            {% else %}
                <span class="badge bg-danger">ë¶ˆí•©ê²©</span>
            {% endif %}
        </td>

        <td>
            <div class="step-container d-flex align-items-center gap-2">
                
                <div class="step-item p-1 border rounded {% if r.log_1st %}bg-light border-primary{% endif %}">
                    <div class="d-flex align-items-center gap-1">
                        <span class="status-dot 
                            {% if r.log_1st %}dot-blue
                            {% elif r.is_pass %}dot-green
                            {% elif not r.is_pass %}dot-red
                            {% else %}dot-gray{% endif %}"
                            style="width: 10px; height: 10px; border-radius: 50%; display: inline-block;">
                        </span>
                        <span class="small fw-bold">1ì°¨</span>

                        {% if r.log_1st %}
                            <button class="btn btn-secondary btn-sm py-0 px-2" 
                                    style="font-size: 0.75rem;" 
                                    onclick="viewLog('{{ r.log_1st.reason|escapejs }}', '{{ r.log_1st.created_at|date:'Y-m-d' }}')">
                                <i class="bi bi-eye"></i> ë‚´ìš©
                            </button>
                        {% elif not r.is_pass %}
                            <button class="btn btn-danger btn-sm py-0 px-2 open-manager-modal"
                                    style="font-size: 0.75rem;"
                                    data-id="{{ profile.id }}"
                                    data-title="{{ r.quiz.title }}"
                                    data-score="{{ r.score }}"
                                    
                                    data-quizid="{{ r.quiz.id }}"   data-stage="1"                  data-bs-toggle="modal" data-bs-target="#managerCounselModal">
                                <i class="bi bi-pencil"></i> ì‘ì„±
                            </button>
                        {% endif %}
                    </div>
                </div>

                <i class="bi bi-chevron-right text-muted small"></i>

                <div class="step-item p-1 border rounded {% if r.log_2nd %}bg-light border-primary{% endif %}">
                    <div class="d-flex align-items-center gap-1">
                        <span class="status-dot {% if r.log_2nd %}dot-blue{% else %}dot-gray{% endif %}"
                              style="width: 10px; height: 10px; border-radius: 50%; display: inline-block;"></span>
                        <span class="small fw-bold">2ì°¨</span>

                        {% if r.log_2nd %}
                            <button class="btn btn-secondary btn-sm py-0 px-2" 
                                    style="font-size: 0.75rem;" 
                                    onclick="viewLog('{{ r.log_2nd.reason|escapejs }}', '{{ r.log_2nd.created_at|date:'Y-m-d' }}')">
                                <i class="bi bi-eye"></i> ë‚´ìš©
                            </button>
                        {% elif r.log_1st and not r.is_pass %}
                            <button class="btn btn-danger btn-sm py-0 px-2 open-manager-modal"
                                    style="font-size: 0.75rem;"
                                    data-id="{{ profile.id }}"
                                    data-title="{{ r.quiz.title }}"
                                    data-score="{{ r.score }}"
                                    
                                    data-quizid="{{ r.quiz.id }}"   data-stage="2"                  data-bs-toggle="modal" data-bs-target="#managerCounselModal">
                                ì‘ì„±
                            </button>
                        {% endif %}
                    </div>
                </div>

                <i class="bi bi-chevron-right text-muted small"></i>

                <div class="step-item p-1 border rounded {% if r.log_final %}bg-dark text-white{% endif %}">
                     <div class="d-flex align-items-center gap-1">
                        <span class="status-dot {% if r.log_final %}dot-black{% else %}dot-gray{% endif %}"
                              style="width: 10px; height: 10px; border-radius: 50%; display: inline-block;"></span>
                        <span class="small fw-bold">í‡´ì†Œ</span>
                        
                        {% if r.log_final %}
                             <span class="badge bg-light text-dark" style="font-size: 0.7rem;">ì²˜ë¦¬ë¨</span>
                        {% elif r.log_2nd and not r.is_pass %}
                            <button class="btn btn-dark btn-sm py-0 px-2 open-manager-modal"
                                    style="font-size: 0.75rem;"
                                    data-id="{{ profile.id }}"
                                    data-title="{{ r.quiz.title }}"
                                    data-score="{{ r.score }}"
                                    
                                    data-quizid="{{ r.quiz.id }}"   data-stage="3"                  data-bs-toggle="modal" data-bs-target="#managerCounselModal">
                                ì²˜ë¦¬
                            </button>
                        {% endif %}
                    </div>
                </div>

            </div>
        </td>

        <td class="text-center small text-muted">{{ r.completed_at|date:"Y-m-d" }}</td>
    </tr>
    {% empty %}
    <tr><td colspan="5" class="text-center py-5 text-muted">ì‘ì‹œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
    {% endfor %}
</tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="tab-logs">
                            <h5 class="fw-bold mb-3">íˆìŠ¤í† ë¦¬</h5>
                            <div class="vstack gap-3">
                                {% for log in logs %}
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body border-start border-4 
                                        {% if log.log_type == 'warning' %}border-warning
                                        {% elif log.log_type == 'warning_letter' %}border-danger
                                        {% elif log.log_type == 'counseling' %}border-success
                                        {% else %}border-secondary{% endif %}">
                                        
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="badge rounded-pill bg-secondary">{{ log.get_log_type_display }}</span>
                                            <small class="text-muted">{{ log.created_at|date:"Y-m-d H:i" }}</small>
                                        </div>
                                        <p class="fw-bold mb-1">{{ log.reason }}</p>
                                        <div class="d-flex justify-content-between align-items-center mt-2">
                                            <small class="text-muted">ì‘ì„±ì: {{ log.recorder.profile.name|default:"ì‹œìŠ¤í…œ" }}</small>
                                            {% if log.is_resolved %}
                                                <span class="badge bg-primary-subtle text-primary"><i class="bi bi-check-all"></i> ì¡°ì¹˜ ì™„ë£Œ</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="text-center text-muted py-5">ê¸°ë¡ëœ íŠ¹ì´ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="tab-pane fade" id="tab-badges">
                            <div class="row g-3">
                                {% for b in badges %}
                                <div class="col-md-6 col-xl-4">
                                    <div class="bg-white p-3 rounded border h-100 d-flex align-items-center shadow-sm">
                                        <div class="fs-1 me-3">ğŸ…</div>
                                        <div>
                                            <div class="fw-bold">{{ b.name }}</div>
                                            <small class="text-muted">{{ b.description }}</small>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="col-12 text-center text-muted py-5">íšë“í•œ ë±ƒì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="managerCounselModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="bi bi-pencil-square"></i> ë©´ë‹´ ê¸°ë¡ (ê°„í¸)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="managerCounselForm">
                    <input type="hidden" id="targetProfileId">
                    <input type="hidden" id="targetQuizId" name="quiz_id">
                    <input type="hidden" id="targetStage" name="stage">
                    
                    <div class="alert alert-light border mb-3">
                        <strong>ì‹œí—˜:</strong> <span id="mgrModalTitle" class="text-primary"></span> / 
                        <strong>ì ìˆ˜:</strong> <span id="mgrModalScore" class="text-danger fw-bold"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">ë©´ë‹´ ë‚´ìš©</label>
                        <textarea id="mgrContent" class="form-control" rows="3" required placeholder="ë©´ë‹´ ë‚´ìš© ì…ë ¥"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">ì¡°ì¹˜ ì˜ê²¬</label>
                        <input type="text" id="mgrOpinion" class="form-control" placeholder="ì˜ˆ: ì¬ì‹œí—˜ ê¸°íšŒ ë¶€ì—¬">
                    </div>

                    <div class="form-check p-3 bg-light border rounded mb-3">
                        <input class="form-check-input" type="checkbox" id="mgrIsPassed" name="is_passed">
                        <label class="form-check-label fw-bold text-danger" for="mgrIsPassed">
                            ğŸ”“ ì¡°ì¹˜ ì™„ë£Œ ë° ì ê¸ˆ í•´ì œ (ì¬ì§ ìƒíƒœë¡œ ë³€ê²½)
                        </label>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">ì €ì¥í•˜ê¸°</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // [ê¸°ëŠ¥ 1] ë‚´ìš© ë³´ê¸° (Alert)
    function viewLog(reason, date) {
        alert("ğŸ“ ì‘ì„±ëœ ê¸°ë¡ (" + date + ")\n\n" + reason);
    }

    document.addEventListener('DOMContentLoaded', function() {
        
        // [ê¸°ëŠ¥ 2] ëª¨ë‹¬ ì—´ë¦´ ë•Œ 'ì‹œí—˜ID'ì™€ 'ë‹¨ê³„'ë¥¼ ë²„íŠ¼ì—ì„œ ë½‘ì•„ì˜¤ê¸°
        const btns = document.querySelectorAll('.open-manager-modal');
        btns.forEach(btn => {
            btn.addEventListener('click', function() {
                // 1. ë²„íŠ¼ì— ì íŒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const pid = this.getAttribute('data-id');
                const title = this.getAttribute('data-title');
                const score = this.getAttribute('data-score');
                
                // [ì¤‘ìš”] ì—¬ê¸°ì„œ quizidì™€ stageë¥¼ ëª» ê°€ì ¸ì˜¤ë©´ ê½ì…ë‹ˆë‹¤.
                const qid = this.getAttribute('data-quizid'); 
                const stage = this.getAttribute('data-stage');
                
                // [ë””ë²„ê¹…] F12 ê°œë°œì ë„êµ¬ ì½˜ì†”ì— ì´ ê°’ì´ ì°í˜€ì•¼ í•©ë‹ˆë‹¤!
                console.log("ì „ì†¡í•  ë°ì´í„° í™•ì¸ -> QuizID:", qid, " / Stage:", stage);

                // 2. ëª¨ë‹¬ì˜ ìˆ¨ê²¨ì§„ Input(hidden)ì— ê°’ ì±„ì›Œë„£ê¸°
                document.getElementById('targetProfileId').value = pid;
                
                // â˜… ì—¬ê¸°ê°€ ë¹„ì–´ìˆìœ¼ë©´ ì•ˆë©ë‹ˆë‹¤!
                document.getElementById('targetQuizId').value = qid; 
                document.getElementById('targetStage').value = stage; 

                // 3. í™”ë©´ í…ìŠ¤íŠ¸ ì„¸íŒ…
                document.getElementById('mgrModalTitle').innerText = title;
                document.getElementById('mgrModalScore').innerText = score + "ì ";
                document.getElementById('mgrContent').value = `[${stage}ì°¨ ê²½ê³ /ë©´ë‹´]\n- ê³¼ëª©: ${title}\n- ì ìˆ˜: ${score}ì \n`;
            });
        });

        // [ê¸°ëŠ¥ 3] ì €ì¥ ë²„íŠ¼ ëˆ„ë¥¼ ë•Œ (ì „ì†¡)
        document.getElementById('managerCounselForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // ìˆ¨ê²¨ì§„ Inputì—ì„œ ê°’ êº¼ë‚´ì˜¤ê¸°
            const pid = document.getElementById('targetProfileId').value;
            const qid = document.getElementById('targetQuizId').value; // â˜… í™•ì¸
            const stage = document.getElementById('targetStage').value; // â˜… í™•ì¸
            
            const content = document.getElementById('mgrContent').value;
            const opinion = document.getElementById('mgrOpinion').value;
            const isPassed = document.getElementById('mgrIsPassed').checked ? 'on' : '';

            // í¼ ë°ì´í„° í¬ì¥
            const formData = new FormData();
            formData.append('content', content);
            formData.append('opinion', opinion);
            formData.append('is_passed', isPassed);
            
            // [í•„ìˆ˜] ì„œë²„ë¡œ quiz_idì™€ stageë¥¼ ê¼­ ë³´ë‚´ì•¼ í•©ë‹ˆë‹¤!
            formData.append('quiz_id', qid); 
            formData.append('stage', stage);

            // ì „ì†¡ ì‹œì‘
            fetch(`/quiz/manager/log/create/${pid}/`, {
                method: 'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    alert("âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    location.reload(); // ìƒˆë¡œê³ ì¹¨í•´ì•¼ ìƒ‰ê¹”ì´ ë°”ë€ë‹ˆë‹¤.
                } else {
                    alert("ì˜¤ë¥˜ ë°œìƒ: " + data.message);
                }
            })
            .catch(err => {
                console.error(err);
                alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
            });
        });
    });
</script>
{% endblock %}