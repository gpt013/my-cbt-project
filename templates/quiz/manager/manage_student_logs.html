{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4" style="max-width: 1000px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold"><i class="bi bi-shield-exclamation text-danger"></i> íŠ¹ì´ì‚¬í•­ ë° ê²½ê³  ê´€ë¦¬</h3>
        <a href="{% url 'quiz:manager_trainee_detail' profile.id %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> ìƒì„¸ í˜ì´ì§€ë¡œ
        </a>
    </div>

    <div class="card bg-white border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="d-flex align-items-center">
                    <h2 class="fw-bold mb-0 me-3">{{ profile.name }}</h2>
                    <span class="badge 
                        {% if profile.status == 'attending' %}bg-success
                        {% elif profile.status == 'caution' %}bg-warning text-dark
                        {% elif profile.status == 'counseling' %}bg-danger
                        {% else %}bg-secondary{% endif %} fs-6">
                        {{ profile.get_status_display }}
                    </span>
                </div>
                <div class="text-end">
                    <h5 class="mb-0 text-muted">ëˆ„ì  ê²½ê³ </h5>
                    <h2 class="fw-bold text-danger mb-0">{{ profile.warning_count }} <span class="fs-6">íšŒ</span></h2>
                </div>
            </div>

            <div class="progress" style="height: 20px;">
                {% with w=profile.warning_count %}
                <div class="progress-bar {% if w >= 4 %}bg-dark{% elif w >= 2 %}bg-danger{% else %}bg-warning{% endif %} progress-bar-striped progress-bar-animated" 
                     role="progressbar" 
                     style="width: {% widthratio w 4 100 %}%;">
                    {% if w > 0 %}{{ w }}íšŒ ëˆ„ì {% endif %}
                </div>
                {% endwith %}
            </div>
            <div class="d-flex justify-content-between small text-muted mt-2 fw-bold">
                <span>ğŸŸ¢ 0íšŒ (ì •ìƒ)</span>
                <span>âš ï¸ 1íšŒ (ì£¼ì˜)</span>
                <span>â›” 2íšŒ (1ì°¨ ê²½ê³ ì¥/ì ê¸ˆ)</span>
                <span>ğŸš« 3íšŒ (2ì°¨ ê²½ê³ ì¥/PLë©´ë‹´)</span>
                <span>âš« 4íšŒ (í‡´ì†Œ)</span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-5">
            <div class="card shadow-sm border-0 sticky-top" style="top: 20px;">
                <div class="card-header bg-primary text-white fw-bold">
                    <i class="bi bi-pencil-square"></i> ìƒˆ ê¸°ë¡ ì‘ì„±
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">ê¸°ë¡ ìœ í˜•</label>
                            {{ form.log_type }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">ì‚¬ìœ  ë° ë‚´ìš© <span class="text-danger">*</span></label>
                            {{ form.reason }}
                            <div class="form-text small">
                                * ê²½ê³  ë°œë¶€ ì‹œ <strong>ìœ¡í•˜ì›ì¹™</strong>ì— ì˜ê±°í•˜ì—¬ êµ¬ì²´ì ì¸ ì‚¬ìœ ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">ì¡°ì¹˜ ì‚¬í•­ (Action Taken)</label>
                            {{ form.action_taken }}
                            <div class="form-text small">
                                * í•™ìƒê³¼ì˜ í•©ì˜ ë‚´ìš©ì´ë‚˜ ë¶€ì—¬ëœ ë²Œì¹™ ë“±ì„ ê¸°ë¡í•˜ì„¸ìš”.
                            </div>
                        </div>

                        <div id="unlockOptions" class="card bg-light border-warning mb-3" style="display: none;">
                            <div class="card-body p-3">
                                <h6 class="fw-bold text-dark border-bottom pb-2 mb-2">ğŸ”“ ì ê¸ˆ í•´ì œ ì˜µì…˜</h6>
                                
                                <div class="form-check mb-2">
                                    <input type="checkbox" class="form-check-input" name="resolve_lock" id="resolveCheck">
                                    <label class="form-check-label fw-bold text-primary" for="resolveCheck">
                                        ì¡°ì¹˜ ì™„ë£Œ ë° ì ê¸ˆ í•´ì œ
                                    </label>
                                </div>

                                {% if profile.warning_count == 3 %}
                                <div class="form-check bg-white p-2 border rounded">
                                    <input type="checkbox" class="form-check-input" name="pl_check" id="plCheck">
                                    <label class="form-check-label text-danger fw-bold small" for="plCheck">
                                        [í•„ìˆ˜] PL(íŒŒíŠ¸ì¥) ë©´ë‹´ ì§„í–‰ í™•ì¸
                                    </label>
                                    <div class="form-text x-small mt-1">
                                        * 3íšŒ ëˆ„ì ìëŠ” PL ë©´ë‹´ì´ í™•ì¸ë˜ì–´ì•¼ë§Œ ì ê¸ˆì´ í•´ì œë©ë‹ˆë‹¤.
                                    </div>
                                </div>
                                {% endif %}
                                
                                <div class="form-text small mt-2 text-muted">
                                    ì²´í¬ ì‹œ ê³„ì • ìƒíƒœê°€ <strong>'ì •ìƒ(ì¬ì§)'</strong>ìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 fw-bold py-2">
                            <i class="bi bi-save"></i> ê¸°ë¡ ì €ì¥í•˜ê¸°
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <h5 class="fw-bold mb-3 mt-4 mt-lg-0"><i class="bi bi-clock-history"></i> ê¸°ë¡ íˆìŠ¤í† ë¦¬</h5>
            
            <div class="vstack gap-3">
                {% for log in logs %}
                <div class="card border-0 shadow-sm">
                    <div class="card-body border-start border-5 
                        {% if log.log_type == 'warning' %}border-warning
                        {% elif log.log_type == 'warning_letter' %}border-danger
                        {% elif log.log_type == 'counseling' %}border-success
                        {% elif log.log_type == 'exam_fail' %}border-secondary
                        {% else %}border-info{% endif %}">
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span class="badge rounded-pill 
                                {% if log.log_type == 'warning' %}bg-warning text-dark
                                {% elif log.log_type == 'warning_letter' %}bg-danger
                                {% elif log.log_type == 'counseling' %}bg-success
                                {% else %}bg-secondary{% endif %}">
                                {{ log.get_log_type_display }}
                            </span>
                            <small class="text-muted">{{ log.created_at|date:"Y-m-d H:i" }}</small>
                        </div>
                        
                        <div class="mb-2">
                            <strong>ë‚´ìš©:</strong><br>
                            {{ log.reason|linebreaksbr }}
                        </div>

                        {% if log.action_taken %}
                        <div class="bg-light p-2 rounded small mb-2 text-secondary">
                            <strong>âš¡ ì¡°ì¹˜:</strong> {{ log.action_taken }}
                        </div>
                        {% endif %}

                        <div class="d-flex justify-content-between align-items-end mt-2 pt-2 border-top">
                            <small class="text-muted">
                                <i class="bi bi-pencil"></i> ê¸°ë¡ì: {{ log.recorder.profile.name|default:"ì‹œìŠ¤í…œ" }}
                            </small>
                            {% if log.is_resolved %}
                                <span class="badge bg-primary-subtle text-primary border border-primary">
                                    <i class="bi bi-check-all"></i> ì¡°ì¹˜ ì™„ë£Œ
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-5 text-muted border rounded bg-light">
                    <i class="bi bi-clipboard-x fs-1 opacity-25"></i>
                    <p class="mt-3 mb-0">ë“±ë¡ëœ íŠ¹ì´ì‚¬í•­ì´ë‚˜ ê²½ê³  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    // 'ë©´ë‹´ ë° ì¡°ì¹˜' ìœ í˜• ì„ íƒ ì‹œì—ë§Œ ì ê¸ˆ í•´ì œ ì˜µì…˜ ë³´ì´ê¸°
    const logTypeSelect = document.getElementById('id_log_type');
    const unlockOptions = document.getElementById('unlockOptions');

    function toggleUnlockOptions() {
        if (logTypeSelect.value === 'counseling') {
            unlockOptions.style.display = 'block';
        } else {
            unlockOptions.style.display = 'none';
            // ìˆ¨ê¸¸ ë•Œ ì²´í¬ë°•ìŠ¤ í•´ì œ (ì‹¤ìˆ˜ ë°©ì§€)
            const resolveCheck = document.getElementById('resolveCheck');
            if(resolveCheck) resolveCheck.checked = false;
            
            const plCheck = document.getElementById('plCheck');
            if(plCheck) plCheck.checked = false;
        }
    }

    if(logTypeSelect) {
        logTypeSelect.addEventListener('change', toggleUnlockOptions);
        // ì´ˆê¸° ë¡œë“œ ì‹œ ìƒíƒœ í™•ì¸
        toggleUnlockOptions();
    }
</script>
{% endblock %}