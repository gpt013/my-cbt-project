{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4" style="max-width: 1000px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold"><i class="bi bi-shield-exclamation text-danger"></i> íŠ¹ì´ì‚¬í•­ ë° ê²½ê³  ê´€ë¦¬</h3>
        <a href="{% url 'quiz:manager_trainee_detail' profile.id %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> ìƒì„¸ í˜ì´ì§€ë¡œ
        </a>
    </div>

    <div class="card bg-white border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="d-flex align-items-center">
                    <h2 class="fw-bold mb-0 me-3">{{ profile.name }}</h2>
                    <span class="badge 
                        {% if profile.status == 'attending' %}bg-success
                        {% elif profile.status == 'caution' %}bg-warning text-dark
                        {% elif profile.status == 'counseling' %}bg-danger
                        {% else %}bg-secondary{% endif %} fs-6">
                        {{ profile.get_status_display }}
                    </span>
                </div>
                <div class="text-end">
                    <h5 class="mb-0 text-muted">ëˆ„ì  ê²½ê³ </h5>
                    <h2 class="fw-bold text-danger mb-0">{{ profile.warning_count }} <span class="fs-6">íšŒ</span></h2>
                </div>
            </div>
            
            <div class="progress" style="height: 20px;">
                {% with w=profile.warning_count %}
                <div class="progress-bar {% if w >= 4 %}bg-dark{% elif w >= 2 %}bg-danger{% else %}bg-warning{% endif %} progress-bar-striped progress-bar-animated" 
                     role="progressbar" 
                     style="width: {% widthratio w 4 100 %}%;">
                    {% if w > 0 %}{{ w }}íšŒ ëˆ„ì {% endif %}
                </div>
                {% endwith %}
            </div>
            <div class="d-flex justify-content-between small text-muted mt-2 fw-bold">
                <span>ğŸŸ¢ 0íšŒ (ì •ìƒ)</span>
                <span>âš ï¸ 1íšŒ (ì£¼ì˜)</span>
                <span>â›” 2íšŒ (1ì°¨ ê²½ê³ ì¥/ì ê¸ˆ)</span>
                <span>ğŸš« 3íšŒ (2ì°¨ ê²½ê³ ì¥/PLë©´ë‹´)</span>
                <span>âš« 4íšŒ (í‡´ì†Œ)</span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-5">
            <div class="card shadow-sm border-0 sticky-top" style="top: 20px;">
                <div class="card-header bg-primary text-white fw-bold">
                    <i class="bi bi-pencil-square"></i> ìƒˆ ê¸°ë¡ ì‘ì„± / ì ê¸ˆ í•´ì œ
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">ê¸°ë¡ ìœ í˜•</label>
                            <select name="log_type" class="form-select" id="logTypeSelect">
                                <option value="counseling">ğŸ”“ ë©´ë‹´ ë° ì ê¸ˆ í•´ì œ (ì‹œí—˜/ê²½ê³  í†µí•©)</option>
                                <option value="warning">âš ï¸ êµ¬ë‘ ê²½ê³  / ì£¼ì˜ (Warning)</option>
                                <option value="warning_letter">â›” ê²½ê³ ì¥ ë°œì†¡ (Warning Letter)</option>
                                <option value="attitude">ğŸ‘ íƒœë„/í–‰ë™ ë¶ˆëŸ‰ (Attitude)</option>
                                <option value="others">ğŸ“ ê¸°íƒ€ íŠ¹ì´ì‚¬í•­ (Others)</option>
                            </select>
                        </div>

                        <div id="lockedExamDiv" class="mb-3 p-3 bg-light border rounded">
                            <label class="form-label fw-bold text-danger">
                                <i class="bi bi-lock-fill"></i> í•´ì œí•  ì‹œí—˜ ì„ íƒ
                            </label>
                            
                            <select name="related_quiz_id" class="form-select" id="lockedQuizSelect">
                                <option value="">-- ì„ íƒí•˜ì„¸ìš” (ìë™ì™„ì„±) --</option>
                                {% for log in locked_logs %}
                                    <option value="{{ log.related_quiz.id }}" 
                                            data-exam-title="{{ log.related_quiz.title }}"
                                            data-fail-stage="{{ log.stage }}"
                                            data-fail-date="{{ log.created_at|date:'Y-m-d' }}">
                                            [ë¶ˆí•©ê²© {{ log.stage }}ì°¨] {{ log.related_quiz.title }} ({{ log.created_at|date:"Y-m-d" }})
                                    </option>
                                {% empty %}
                                    <option value="" disabled>í˜„ì¬ ì ê²¨ìˆëŠ” ì‹œí—˜ì´ ì—†ìŠµë‹ˆë‹¤.</option>
                                {% endfor %}
                            </select>
                            <div class="form-text small text-muted mt-2">
                                * ëª©ë¡ì— ì—†ëŠ” ì‹œí—˜ì€ ì´ë¯¸ í•´ì œë˜ì—ˆê±°ë‚˜ ì •ìƒ ìƒíƒœì…ë‹ˆë‹¤.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">ì‚¬ìœ  ë° ë‚´ìš© <span class="text-danger">*</span></label>
                            <textarea name="reason" id="reasonArea" class="form-control" rows="4" required></textarea>
                            <div class="form-text small">
                                * ì‹œí—˜ì„ ì„ íƒí•˜ë©´ ë‚´ìš©ì´ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">ì¡°ì¹˜ ì‚¬í•­ (Action Taken)</label>
                            <input type="text" name="action_taken" id="actionInput" class="form-control">
                        </div>

                        <div id="unlockOptions" class="card bg-light border-warning mb-3">
                            <div class="card-body p-3">
                                <h6 class="fw-bold text-dark border-bottom pb-2 mb-2">ğŸ”“ ì ê¸ˆ í•´ì œ ì˜µì…˜</h6>
                                
                                <div class="form-check mb-2">
                                    <input type="checkbox" class="form-check-input" name="resolve_lock" id="resolveCheck">
                                    <label class="form-check-label fw-bold text-primary" for="resolveCheck">
                                        ì¡°ì¹˜ ì™„ë£Œ ë° ì ê¸ˆ í•´ì œ
                                    </label>
                                </div>

                                {% if profile.warning_count == 3 %}
                                <div class="form-check bg-white p-2 border rounded mt-2">
                                    <input type="checkbox" class="form-check-input" name="pl_check" id="plCheck">
                                    <label class="form-check-label text-danger fw-bold small" for="plCheck">
                                        [í•„ìˆ˜] PL(íŒŒíŠ¸ì¥) ë©´ë‹´ ì§„í–‰ í™•ì¸
                                    </label>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 fw-bold py-2">
                            <i class="bi bi-save"></i> ê¸°ë¡ ì €ì¥ ë° ì ìš©
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <h5 class="fw-bold mb-3 mt-4 mt-lg-0"><i class="bi bi-clock-history"></i> ê¸°ë¡ íˆìŠ¤í† ë¦¬</h5>
            
            <div class="vstack gap-3">
                {% for log in logs %}
                <div class="card border-0 shadow-sm">
                    <div class="card-body border-start border-5 
                        {% if log.log_type == 'warning' %}border-warning
                        {% elif log.log_type == 'warning_letter' %}border-danger
                        {% elif log.log_type == 'counseling' %}border-success
                        {% elif log.log_type == 'exam_fail' %}border-secondary
                        {% else %}border-info{% endif %}">
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span class="badge rounded-pill 
                                {% if log.log_type == 'warning' %}bg-warning text-dark
                                {% elif log.log_type == 'warning_letter' %}bg-danger
                                {% elif log.log_type == 'counseling' %}bg-success
                                {% elif log.log_type == 'exam_fail' %}bg-secondary
                                {% else %}bg-info text-dark{% endif %}">
                                {{ log.get_log_type_display }}
                            </span>
                            <small class="text-muted">{{ log.created_at|date:"Y-m-d H:i" }}</small>
                        </div>
                        
                        <div class="mb-2">
                            <strong>ë‚´ìš©:</strong><br>
                            {{ log.reason|linebreaksbr }}
                        </div>

                        {% if log.related_quiz %}
                        <div class="small text-primary mb-2">
                            <i class="bi bi-clipboard-check"></i> ê´€ë ¨ ì‹œí—˜: {{ log.related_quiz.title }}
                        </div>
                        {% endif %}

                        {% if log.action_taken %}
                        <div class="bg-light p-2 rounded small mb-2 text-secondary">
                            <strong>âš¡ ì¡°ì¹˜:</strong> {{ log.action_taken }}
                        </div>
                        {% endif %}

                        <div class="d-flex justify-content-between align-items-end mt-2 pt-2 border-top">
                            <small class="text-muted">
                                <i class="bi bi-pencil"></i> ê¸°ë¡ì: {{ log.recorder.profile.name|default:"ì‹œìŠ¤í…œ" }}
                            </small>
                            {% if log.is_resolved %}
                                <span class="badge bg-primary-subtle text-primary border border-primary">
                                    <i class="bi bi-check-all"></i> ì¡°ì¹˜ ì™„ë£Œ
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-5 text-muted border rounded bg-light">
                    <i class="bi bi-clipboard-x fs-1 opacity-25"></i>
                    <p class="mt-3 mb-0">ë“±ë¡ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const logTypeSelect = document.getElementById('logTypeSelect');
        const lockedExamDiv = document.getElementById('lockedExamDiv');
        const unlockOptions = document.getElementById('unlockOptions');
        const quizSelect = document.getElementById('lockedQuizSelect');
        const reasonArea = document.getElementById('reasonArea');
        const actionInput = document.getElementById('actionInput');
        const resolveCheck = document.getElementById('resolveCheck');

        // 1. [UI ì œì–´] ê¸°ë¡ ìœ í˜•ì— ë”°ë¼ í™”ë©´ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°
        function toggleUI() {
            // 'counseling'(ë©´ë‹´)ì¼ ë•Œë§Œ ì ê¸ˆ í•´ì œ ê´€ë ¨ UI í‘œì‹œ
            if (logTypeSelect.value === 'counseling') {
                lockedExamDiv.style.display = 'block';
                unlockOptions.style.display = 'block';
            } else {
                // ê²½ê³ ì¥(warning_letter), ê²½ê³ (warning), ê¸°íƒ€ ë“±ì¼ ë•ŒëŠ” ìˆ¨ê¹€
                lockedExamDiv.style.display = 'none';
                unlockOptions.style.display = 'none';
                
                // ìˆ¨ê¸¸ ë•Œ ì²´í¬ë°•ìŠ¤ì™€ ì„ íƒê°’ ì´ˆê¸°í™” (ì˜¤ë¥˜ ë°©ì§€)
                if(resolveCheck) resolveCheck.checked = false;
                if(quizSelect) quizSelect.value = "";
            }
        }

        // 2. [ìë™ì™„ì„±] ì‹œí—˜ ì„ íƒ ì‹œ ë‚´ìš© ìë™ ì±„ìš°ê¸°
        if (quizSelect) {
            quizSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                
                if (this.value) {
                    // HTML data ì†ì„±ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
                    const title = selectedOption.getAttribute('data-exam-title');
                    const stage = selectedOption.getAttribute('data-fail-stage');
                    const date = selectedOption.getAttribute('data-fail-date');
                    
                    // ì²´í¬ë°•ìŠ¤ ìë™ ì²´í¬
                    if(resolveCheck) resolveCheck.checked = true;

                    // ì‚¬ìœ  ë° ë‚´ìš© ìë™ ì±„ìš°ê¸° (ì´ë¯¸ ë‚´ìš©ì´ ìˆìœ¼ë©´ ë®ì–´ì“°ì§€ ì•ŠìŒ)
                    if (!reasonArea.value.trim()) { 
                        reasonArea.value = `[${stage}ì°¨ ë¶ˆí•©ê²© ë©´ë‹´]\n- ì‹œí—˜ëª…: ${title}\n- ì‘ì‹œì¼: ${date}\n\n[ë©´ë‹´ ë‚´ìš©]\n- ë¶ˆí•©ê²© ì‚¬ìœ  íŒŒì•… ë° ì¬ì‘ì‹œ ê¸°íšŒ ë¶€ì—¬í•¨.`;
                    }
                    if (!actionInput.value.trim()) {
                        actionInput.value = "ì¬ì‘ì‹œ ì ê¸ˆ í•´ì œ ì™„ë£Œ";
                    }
                } else {
                    // ì„ íƒ ì·¨ì†Œ ì‹œ ì²´í¬ í•´ì œ
                    if(resolveCheck) resolveCheck.checked = false;
                }
            });
        }

        // ì´ˆê¸° ì‹¤í–‰ ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
        if(logTypeSelect) {
            logTypeSelect.addEventListener('change', toggleUI);
            toggleUI(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ìƒíƒœ ë°˜ì˜
        }
    });
</script>
{% endblock %}