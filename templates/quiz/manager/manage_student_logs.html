{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4" style="max-width: 1200px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold"><i class="bi bi-shield-exclamation text-danger"></i> êµìœ¡ìƒ í†µí•© ê´€ë¦¬</h3>
        <div>
            <a href="{% url 'quiz:manager_trainee_detail' profile.id %}" class="btn btn-secondary me-2">
                <i class="bi bi-arrow-left"></i> ìƒì„¸ ì •ë³´
            </a>
            <a href="{% url 'quiz:dashboard' %}" class="btn btn-outline-secondary">
                <i class="bi bi-grid-3x3-gap"></i> ëŒ€ì‹œë³´ë“œ
            </a>
        </div>
    </div>

    <div class="card bg-white border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="d-flex align-items-center">
                    <h2 class="fw-bold mb-0 me-3">{{ profile.name }}</h2>
                    <span class="badge 
                        {% if profile.status == 'attending' %}bg-success
                        {% elif profile.status == 'caution' %}bg-warning text-dark
                        {% elif profile.status == 'counseling' %}bg-danger
                        {% else %}bg-secondary{% endif %} fs-6">
                        {{ profile.get_status_display }}
                    </span>
                    <span class="ms-2 text-muted small">({{ profile.process.name }} / {{ profile.cohort.name }})</span>
                </div>
                <div class="text-end">
                    <h5 class="mb-0 text-muted">ëˆ„ì  ê²½ê³ </h5>
                    <h2 class="fw-bold text-danger mb-0">{{ profile.warning_count }} <span class="fs-6">íšŒ</span></h2>
                </div>
            </div>
            
            <div class="progress" style="height: 20px;">
                {% with w=profile.warning_count %}
                <div class="progress-bar {% if w >= 4 %}bg-dark{% elif w >= 2 %}bg-danger{% else %}bg-warning{% endif %} progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: {% widthratio w 4 100 %}%;">
                    {% if w > 0 %}{{ w }}íšŒ ëˆ„ì {% endif %}
                </div>
                {% endwith %}
            </div>

            <div class="d-flex justify-content-between small text-muted mt-2 fw-bold">
                <span>ğŸŸ¢ 0íšŒ (ì •ìƒ)</span>
                <span>âš ï¸ 1íšŒ (ì£¼ì˜)</span>
                <span>â›” 2íšŒ (1ì°¨ ê²½ê³ ì¥/ì ê¸ˆ)</span>
                <span>ğŸš« 3íšŒ (2ì°¨ ê²½ê³ ì¥/PLë©´ë‹´)</span>
                <span>âš« 4íšŒ (í‡´ì†Œ)</span>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4 border-0">
        <div class="card-header bg-primary bg-opacity-10 text-primary fw-bold">
            <i class="bi bi-diagram-3-fill"></i> ì‹œí—˜ ì§„í–‰ ë‹¨ê³„ ë° ê²°ê³¼ (Curriculum Process)
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 text-center">
                    <thead class="bg-light">
                        <tr>
                            <th width="20%">ì‹œí—˜ëª…</th>
                            <th width="10%">ìµœê·¼ ì ìˆ˜</th>
                            <th width="10%">ìƒíƒœ</th>
                            <th width="40%">ì§„í–‰ ë‹¨ê³„ (Process)</th>
                            <th width="20%">ìµœì¢… ì‘ì‹œì¼</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in exam_process_list %}
                        <tr>
                            <td class="text-start ps-4 fw-bold">
                                {% if item.quiz.category == 'common' %}
                                    <span class="badge bg-secondary me-1">ê³µí†µ</span>
                                {% else %}
                                    <span class="badge bg-info text-dark me-1">ê³µì •</span>
                                {% endif %}
                                {{ item.quiz.title }}
                            </td>
                            <td class="fw-bold {% if item.status == 'fail' %}text-danger{% elif item.status == 'pass' %}text-primary{% endif %}">
                                {{ item.score }}
                            </td>
                            <td>
                                {% if item.status == 'pass' %}
                                    <span class="badge bg-primary">í•©ê²©</span>
                                {% elif item.status == 'fail' %}
                                    <span class="badge bg-danger">ë¶ˆí•©ê²©</span>
                                    {% if item.is_locked %}
                                        <div class="mt-1"><span class="badge bg-warning text-dark"><i class="bi bi-lock-fill"></i> ì ê¹€</span></div>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-secondary bg-opacity-50">ë¯¸ì‘ì‹œ</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex justify-content-center align-items-center gap-2">
                                    <button type="button" class="btn btn-sm position-relative {% if item.try_1 %}{% if item.try_1.is_pass %}btn-outline-primary active{% else %}btn-outline-danger active{% endif %}{% else %}btn-outline-secondary disabled opacity-25{% endif %}" style="width: 70px;">
                                        1ì°¨{% if item.try_1 %}<span class="d-block x-small">{{ item.try_1.score }}ì </span>{% endif %}
                                    </button>
                                    <i class="bi bi-chevron-right text-muted"></i>
                                    <button type="button" class="btn btn-sm position-relative {% if item.try_2 %}{% if item.try_2.is_pass %}btn-outline-primary active{% else %}btn-outline-danger active{% endif %}{% else %}btn-outline-secondary disabled opacity-25{% endif %}" style="width: 70px;">
                                        2ì°¨{% if item.try_2 %}<span class="d-block x-small">{{ item.try_2.score }}ì </span>{% endif %}
                                    </button>
                                    <i class="bi bi-chevron-right text-muted"></i>
                                    <button type="button" class="btn btn-sm position-relative {% if item.try_3 %}{% if item.try_3.is_pass %}btn-outline-primary active{% else %}btn-outline-danger active{% endif %}{% else %}btn-outline-secondary disabled opacity-25{% endif %}" style="width: 70px;">
                                        3ì°¨+
                                    </button>
                                </div>
                            </td>
                            <td class="text-muted small">{{ item.date|default:"-" }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5" class="py-4 text-muted">ë“±ë¡ëœ ì‹œí—˜ ì»¤ë¦¬í˜ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-5">
            <div class="card shadow-sm border-0 sticky-top" style="top: 20px;">
                <div class="card-header bg-dark text-white fw-bold">
                    <i class="bi bi-pencil-square"></i> ê´€ë¦¬ì ì¡°ì¹˜ / ê¸°ë¡ ì‘ì„±
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label fw-bold">ê¸°ë¡ ìœ í˜•</label>
                            <select name="log_type" class="form-select" id="logTypeSelect">
                                <option value="counseling">ğŸ”“ ë©´ë‹´ ë° ì ê¸ˆ í•´ì œ (ì‹œí—˜/ê²½ê³  í†µí•©)</option>
                                <option value="warning">âš ï¸ êµ¬ë‘ ê²½ê³  / ì£¼ì˜ (Warning)</option>
                                <option value="warning_letter">â›” ê²½ê³ ì¥ ë°œì†¡ (Warning Letter)</option>
                                <option value="attitude">ğŸ‘ íƒœë„/í–‰ë™ ë¶ˆëŸ‰ (Attitude)</option>
                                <option value="others">ğŸ“ ê¸°íƒ€ íŠ¹ì´ì‚¬í•­ (Others)</option>
                            </select>
                        </div>

                        <div id="lockedExamDiv" class="mb-3 p-3 bg-light border rounded">
                            <label class="form-label fw-bold text-danger"><i class="bi bi-lock-fill"></i> í•´ì œí•  ì‹œí—˜ ì„ íƒ</label>
                            <select name="related_quiz_id" class="form-select" id="lockedQuizSelect">
                                <option value="">-- ì„ íƒ ì•ˆ í•¨ (ê²½ê³  ëˆ„ì  í•´ì œ ì‹œ) --</option>
                                {% for log in locked_logs %}
                                    <option value="{{ log.related_quiz.id }}" 
                                            data-exam-title="{{ log.related_quiz.title }}"
                                            data-fail-stage="ì¬ì‘ì‹œ"
                                            data-fail-date="{{ log.created_at|date:'Y-m-d' }}">
                                            [ë¶ˆí•©ê²©] {{ log.related_quiz.title }} ({{ log.created_at|date:"Y-m-d" }})
                                    </option>
                                {% empty %}
                                    <option value="" disabled>í˜„ì¬ ì ê²¨ìˆëŠ” ì‹œí—˜ì´ ì—†ìŠµë‹ˆë‹¤.</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">ì‚¬ìœ  ë° ë‚´ìš© <span class="text-danger">*</span></label>
                            <textarea name="reason" id="reasonArea" class="form-control" rows="4" required></textarea>
                            <div class="form-text small">* ì‹œí—˜ì„ ì„ íƒí•˜ë©´ ë‚´ìš©ì´ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤.</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">ì¡°ì¹˜ ì‚¬í•­</label>
                            <input type="text" name="action_taken" id="actionInput" class="form-control">
                        </div>

                        <div id="unlockOptions" class="card bg-light border-warning mb-3">
                            <div class="card-body p-3">
                                <h6 class="fw-bold text-dark border-bottom pb-2 mb-2">ğŸ”“ ì ê¸ˆ í•´ì œ ì˜µì…˜</h6>
                                <div class="form-check mb-2">
                                    <input type="checkbox" class="form-check-input" name="resolve_lock" id="resolveCheck">
                                    <label class="form-check-label fw-bold text-primary" for="resolveCheck">ì¡°ì¹˜ ì™„ë£Œ ë° ì ê¸ˆ í•´ì œ</label>
                                </div>
                                {% if profile.warning_count == 3 %}
                                <div class="form-check bg-white p-2 border rounded mt-2">
                                    <input type="checkbox" class="form-check-input" name="pl_check" id="plCheck">
                                    <label class="form-check-label text-danger fw-bold small" for="plCheck">[í•„ìˆ˜] PL(íŒŒíŠ¸ì¥) ë©´ë‹´ ì§„í–‰ í™•ì¸</label>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 fw-bold py-2"><i class="bi bi-save"></i> ê¸°ë¡ ì €ì¥ ë° ì ìš©</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <h5 class="fw-bold mb-3 mt-4 mt-lg-0"><i class="bi bi-clock-history"></i> ê¸°ë¡ íˆìŠ¤í† ë¦¬</h5>
            <div class="vstack gap-3">
                {% for log in logs %}
                <div class="card border-0 shadow-sm">
                    <div class="card-body border-start border-5 
                        {% if log.log_type == 'warning' %}border-warning
                        {% elif log.log_type == 'warning_letter' %}border-danger
                        {% elif log.log_type == 'counseling' %}border-success
                        {% elif log.log_type == 'exam_fail' %}border-secondary
                        {% else %}border-info{% endif %}">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="badge rounded-pill {% if log.log_type == 'warning' %}bg-warning text-dark{% elif log.log_type == 'warning_letter' %}bg-danger{% elif log.log_type == 'counseling' %}bg-success{% else %}bg-secondary{% endif %}">{{ log.get_log_type_display }}</span>
                            <small class="text-muted">{{ log.created_at|date:"Y-m-d H:i" }}</small>
                        </div>
                        <div class="mb-2"><strong>ë‚´ìš©:</strong><br>{{ log.reason|linebreaksbr }}</div>
                        {% if log.related_quiz %}<div class="small text-primary mb-2"><i class="bi bi-clipboard-check"></i> ê´€ë ¨ ì‹œí—˜: {{ log.related_quiz.title }}</div>{% endif %}
                        {% if log.action_taken %}<div class="bg-light p-2 rounded small mb-2 text-secondary"><strong>âš¡ ì¡°ì¹˜:</strong> {{ log.action_taken }}</div>{% endif %}
                        <div class="d-flex justify-content-between align-items-end mt-2 pt-2 border-top">
                            <small class="text-muted"><i class="bi bi-pencil"></i> ê¸°ë¡ì: {{ log.recorder.profile.name|default:"ì‹œìŠ¤í…œ" }}</small>
                            {% if log.is_resolved %}<span class="badge bg-primary-subtle text-primary border border-primary"><i class="bi bi-check-all"></i> ì¡°ì¹˜ ì™„ë£Œ</span>{% endif %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-5 text-muted border rounded bg-light"><p class="mb-0">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const logTypeSelect = document.getElementById('logTypeSelect');
        const lockedExamDiv = document.getElementById('lockedExamDiv');
        const unlockOptions = document.getElementById('unlockOptions');
        const quizSelect = document.getElementById('lockedQuizSelect');
        const reasonArea = document.getElementById('reasonArea');
        const actionInput = document.getElementById('actionInput');
        const resolveCheck = document.getElementById('resolveCheck');

        function toggleUI() {
            if (logTypeSelect.value === 'counseling') {
                lockedExamDiv.style.display = 'block';
                unlockOptions.style.display = 'block';
            } else {
                lockedExamDiv.style.display = 'none';
                unlockOptions.style.display = 'none';
                if(resolveCheck) resolveCheck.checked = false;
                if(quizSelect) quizSelect.value = "";
            }
        }

        if (quizSelect) {
            quizSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (this.value) {
                    const title = selectedOption.getAttribute('data-exam-title');
                    const stage = selectedOption.getAttribute('data-fail-stage');
                    const date = selectedOption.getAttribute('data-fail-date');
                    
                    if(resolveCheck) resolveCheck.checked = true;
                    
                    // [ëˆ„ë½ ë³´ì™„ 2] ì°¨ìˆ˜(stage)ì™€ ë‚ ì§œ(date)ë¥¼ í¬í•¨í•˜ì—¬ ìƒì„¸ ë‚´ìš© ìë™ ì…ë ¥
                    if (!reasonArea.value.trim()) { 
                        reasonArea.value = `[${stage}ì°¨ ë¶ˆí•©ê²© ë©´ë‹´]\n- ì‹œí—˜ëª…: ${title}\n- ì‘ì‹œì¼: ${date}\n\n[ë©´ë‹´ ë‚´ìš©]\n- ë¶ˆí•©ê²© ì‚¬ìœ  íŒŒì•… ë° ì¬ì‘ì‹œ ê¸°íšŒ ë¶€ì—¬í•¨.`;
                    }
                    if (!actionInput.value.trim()) actionInput.value = "ì¬ì‘ì‹œ ì ê¸ˆ í•´ì œ ì™„ë£Œ";
                }
            });
        }
        
        if(logTypeSelect) {
            logTypeSelect.addEventListener('change', toggleUI);
            toggleUI();
        }
    });
</script>
{% endblock %}