{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4 mb-5" style="max-width: 1200px;">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-danger">
            <i class="bi bi-shield-exclamation"></i> íŠ¹ì´ì‚¬í•­ ë° ê²½ê³  ê´€ë¦¬
        </h3>
        <a href="{% url 'quiz:manager_trainee_detail' profile.id %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> ìƒì„¸ í˜ì´ì§€ë¡œ
        </a>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body d-flex align-items-center justify-content-between">
            <div>
                <h4 class="fw-bold d-inline-block me-2">{{ profile.name }}</h4>
                {% if profile.status == 'attending' %}
                    <span class="badge bg-success">ì¬ì§ (ì •ìƒ)</span>
                {% elif profile.status == 'counseling' %}
                    <span class="badge bg-danger">ê´€ë¦¬/ì ê¸ˆ</span>
                {% else %}
                    <span class="badge bg-secondary">{{ profile.get_status_display }}</span>
                {% endif %}
            </div>
            <div class="text-end">
                <small class="text-muted d-block">ëˆ„ì  ê²½ê³ </small>
                <h3 class="fw-bold text-danger m-0">{{ profile.warning_count }} <span class="fs-6 text-muted">íšŒ</span></h3>
            </div>
        </div>
        <div class="progress rounded-0" style="height: 10px;">
            <div class="progress-bar bg-danger" role="progressbar" style="width: {% widthratio profile.warning_count 4 100 %}%"></div>
        </div>
        <div class="d-flex justify-content-between px-2 small text-muted bg-light border-top">
            <span>0íšŒ (ì •ìƒ)</span>
            <span>2íšŒ (1ì°¨ ê²½ê³ ì¥/ì ê¸ˆ)</span>
            <span>3íšŒ (2ì°¨ ê²½ê³ ì¥/PLë©´ë‹´)</span>
            <span>4íšŒ (í‡´ì†Œ)</span>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm border-0 border-top border-3 border-primary">
                <div class="card-header bg-primary text-white fw-bold">
                    <i class="bi bi-pencil-square"></i> ìƒˆ ê¸°ë¡ ì‘ì„±
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">ê¸°ë¡ ìœ í˜•</label>
                            <select name="log_type" id="logTypeSelect" class="form-select" onchange="toggleUnlockOption()">
                                <option value="counseling">ğŸ’¬ ë©´ë‹´ (Counseling)</option>
                                <option value="warning">âš ï¸ ê²½ê³  (Warning)</option>
                                <option value="warning_letter">ğŸš« ê²½ê³ ì¥ (Letter)</option>
                                <option value="exam_fail">âŒ ì‹œí—˜ ë¶ˆí•©ê²© (Exam Fail)</option>
                                <option value="compliment">ğŸ‘ ì¹­ì°¬ (Compliment)</option>
                                <option value="etc">ğŸ“ ê¸°íƒ€ (Etc)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">ì‚¬ìœ  ë° ë‚´ìš© <span class="text-danger">*</span></label>
                            <textarea name="reason" class="form-control" rows="5" required placeholder="êµ¬ì²´ì ì¸ ì‚¬ìœ ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”."></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">ì¡°ì¹˜ ì‚¬í•­ (Action Taken)</label>
                            <textarea name="action_taken" class="form-control" rows="3" placeholder="í•©ì˜ ë‚´ìš©ì´ë‚˜ ë¶€ì—¬ëœ ë²Œì¹™ ë“±ì„ ê¸°ë¡í•˜ì„¸ìš”."></textarea>
                        </div>

                        <div id="unlockOptionBox" class="card bg-warning-subtle border-warning mb-3">
                            <div class="card-body p-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="is_unlocked" id="unlockCheck">
                                    <label class="form-check-label fw-bold text-dark" for="unlockCheck">
                                        ğŸ”“ ì¡°ì¹˜ ì™„ë£Œ ë° ì ê¸ˆ í•´ì œ
                                    </label>
                                </div>
                                <div class="small text-muted mt-1 ms-4">
                                    ì²´í¬ ì‹œ ê³„ì • ìƒíƒœê°€ 'ì •ìƒ(ì¬ì§)'ìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.
                                </div>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary fw-bold">
                                <i class="bi bi-download"></i> ê¸°ë¡ ì €ì¥í•˜ê¸°
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <h5 class="fw-bold mb-3"><i class="bi bi-clock-history"></i> ê¸°ë¡ íˆìŠ¤í† ë¦¬</h5>
            
            <div class="vstack gap-3">
                {% for log in logs %}
                <div class="card border-0 shadow-sm border-start border-4 
                    {% if log.log_type == 'warning' %}border-warning
                    {% elif log.log_type == 'warning_letter' %}border-danger
                    {% elif log.log_type == 'exam_fail' %}border-danger
                    {% elif log.log_type == 'counseling' %}border-success
                    {% else %}border-secondary{% endif %}">
                    
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="badge rounded-pill 
                                {% if log.log_type == 'warning' %}bg-warning text-dark
                                {% elif log.log_type == 'warning_letter' %}bg-danger
                                {% elif log.log_type == 'exam_fail' %}bg-danger
                                {% elif log.log_type == 'counseling' %}bg-success
                                {% else %}bg-secondary{% endif %}">
                                {{ log.get_log_type_display }}
                            </span>
                            <small class="text-muted">{{ log.created_at|date:"Y-m-d H:i" }}</small>
                        </div>
                        
                        <div class="mb-2">
                            <strong>ë‚´ìš©:</strong><br>
                            {{ log.reason|linebreaksbr }}
                        </div>

                        {% if log.action_taken %}
                        <div class="mb-2 text-muted small">
                            <strong>- ì¡°ì¹˜:</strong> {{ log.action_taken }}
                        </div>
                        {% endif %}

                        <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top">
                            <small class="text-muted"><i class="bi bi-pencil"></i> ê¸°ë¡ì: {{ log.recorder.profile.name|default:"ì‹œìŠ¤í…œ" }}</small>
                            {% if log.is_resolved %}
                                <span class="badge bg-primary-subtle text-primary border border-primary-subtle">
                                    <i class="bi bi-check-all"></i> ì¡°ì¹˜ ì™„ë£Œ
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-muted py-5">
                    ê¸°ë¡ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    // [í•µì‹¬ ë¡œì§] ì„ íƒëœ ìœ í˜•ì— ë”°ë¼ 'ì ê¸ˆ í•´ì œ ì˜µì…˜' ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°
    function toggleUnlockOption() {
        const select = document.getElementById('logTypeSelect');
        const unlockBox = document.getElementById('unlockOptionBox');
        const value = select.value;

        // ë©´ë‹´(counseling), ê²½ê³ (warning), ê²½ê³ ì¥(warning_letter), ì‹œí—˜ë¶ˆí•©ê²©(exam_fail) ì¼ ë•Œ ë³´ì„
        if (['counseling', 'warning', 'warning_letter', 'exam_fail'].includes(value)) {
            unlockBox.style.display = 'block';
        } else {
            unlockBox.style.display = 'none';
            // ìˆ¨ê¸¸ ë•Œ ì²´í¬ë°•ìŠ¤ í•´ì œ (ì‹¤ìˆ˜ ë°©ì§€)
            document.getElementById('unlockCheck').checked = false;
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ìƒíƒœ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', toggleUnlockOption);
</script>
{% endblock %}
