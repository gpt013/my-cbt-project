{% extends 'base.html' %}
{% load static %}

{% block content %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/tagify/4.17.9/tagify.min.css" rel="stylesheet" type="text/css" />

<div class="container mt-4" style="max-width: 900px;">
    <div class="card shadow border-0">
        <div class="card-header bg-white py-3 border-bottom">
            <h4 class="mb-0 fw-bold text-primary">
                {% if question %}
                    <i class="bi bi-pencil-square"></i> 문제 수정
                {% else %}
                    <i class="bi bi-plus-circle-fill"></i> 새 문제 등록
                {% endif %}
            </h4>
        </div>

        <div class="card-body p-4">
            <form method="post" enctype="multipart/form-data" id="questionForm">
                {% csrf_token %}
                
                {% if quiz %}
                    <input type="hidden" name="quiz_id" value="{{ quiz.id }}">
                {% endif %}

                <h6 class="fw-bold text-secondary mb-3"><i class="bi bi-info-circle"></i> 기본 정보</h6>
                
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="question_type" class="form-label fw-bold">문제 유형</label>
                        <select name="question_type" id="question_type" class="form-select">
                            <option value="multiple_choice" {% if question.question_type == 'multiple_choice' %}selected{% endif %}>객관식 (단일 정답)</option>
                            <option value="multiple_select" {% if question.question_type == 'multiple_select' %}selected{% endif %}>객관식 (복수 정답)</option>
                            <option value="short_answer" {% if question.question_type == 'short_answer' %}selected{% endif %}>주관식 (단답형)</option>
                            <option value="true_false" {% if question.question_type == 'true_false' %}selected{% endif %}>OX 퀴즈</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="difficulty" class="form-label fw-bold">난이도</label>
                        <select name="difficulty" id="difficulty" class="form-select">
                            <option value="1" {% if question.difficulty == 1 %}selected{% endif %}>하</option>
                            <option value="2" {% if question.difficulty == 2 %}selected{% endif %}>중</option>
                            <option value="3" {% if question.difficulty == 3 %}selected{% endif %}>상</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="question_text" class="form-label fw-bold">질문 내용 <span class="text-danger">*</span></label>
                    <textarea name="question_text" id="question_text" class="form-control" rows="3" required placeholder="질문을 입력하세요">{{ question.question_text|default:'' }}</textarea>
                </div>

                <div class="mb-4">
                    <label for="question_image" class="form-label fw-bold">문제 이미지 (선택)</label>
                    <input type="file" name="image" id="question_image" class="form-control" accept="image/*">
                    {% if question.image %}
                        <div class="mt-2 p-2 border rounded bg-light d-flex align-items-center">
                            <i class="bi bi-image me-2 text-primary"></i>
                            <span class="small text-muted me-2">현재 파일:</span>
                            <a href="{{ question.image.url }}" target="_blank" class="fw-bold text-decoration-none">{{ question.image.name }}</a>
                        </div>
                    {% endif %}
                </div>

                <div class="mb-5">
                    <label for="tags" class="form-label fw-bold"><i class="bi bi-tags-fill"></i> 태그</label>
                    <input name="tags" id="tags" class="form-control" 
                           placeholder="태그 입력 후 엔터" 
                           value="{% for tag in question.tags.all %}{{ tag.name }}{% if not forloop.last %},{% endif %}{% endfor %}">
                    <div class="form-text small">기존 태그를 검색하거나 새로운 태그를 입력하세요.</div>
                </div>

                <h6 class="fw-bold text-secondary mb-3 border-top pt-4"><i class="bi bi-check2-circle"></i> 정답 및 보기 설정</h6>

                <div id="ui_choice" class="type-ui">
                    <div id="choice_msg" class="alert alert-primary py-2 small mb-3">
                        <i class="bi bi-info-circle-fill"></i> 보기를 입력하고 정답을 체크해주세요.
                    </div>
                    {% for i in "1234" %}
                    <div class="input-group mb-3 align-items-center bg-light p-2 rounded">
                        <span class="input-group-text fw-bold border-0 bg-transparent" style="width: 80px;">{{ forloop.counter }}번 보기</span>
                        <input type="text" class="form-control ui-choice-text" data-index="{{ forloop.counter }}" placeholder="보기 내용을 입력하세요">
                        <div class="input-group-text bg-transparent border-0">
                            <div class="form-check form-switch">
                                <input class="form-check-input ui-choice-correct" type="checkbox" data-index="{{ forloop.counter }}" id="ui_check_{{ forloop.counter }}">
                                <label class="form-check-label fw-bold text-primary" for="ui_check_{{ forloop.counter }}">정답</label>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div id="ui_short" class="type-ui" style="display: none;">
                    <label class="form-label fw-bold text-success">정답 단어</label>
                    <input type="text" id="ui_short_input" class="form-control form-control-lg mb-3" placeholder="예: 사과">
                    
                    <div class="alert alert-warning border-warning text-dark">
                        <i class="bi bi-lightbulb-fill text-warning"></i> <strong>입력 팁:</strong><br>
                        <small>1. 대소문자(Apple/apple)는 자동으로 정답 처리됩니다.<br>
                        2. 완전히 다른 단어(동의어)를 정답으로 추가할 때만 콤마(,)를 사용하세요. (예: 사과, apple)</small>
                    </div>
                </div>

                <div id="ui_ox" class="type-ui" style="display: none;">
                    <label class="form-label fw-bold mb-3">정답을 선택하세요</label>
                    <div class="d-flex gap-4 justify-content-center p-4 border rounded bg-light">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="ui_ox_radio" id="ui_ox_o" value="O" style="transform: scale(1.5);">
                            <label class="form-check-label fs-4 fw-bold text-primary ms-2" for="ui_ox_o">O (그렇다)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="ui_ox_radio" id="ui_ox_x" value="X" style="transform: scale(1.5);">
                            <label class="form-check-label fs-4 fw-bold text-danger ms-2" for="ui_ox_x">X (아니다)</label>
                        </div>
                    </div>
                </div>

                <div id="hidden_payload" class="d-none">
                    {% for i in "1234" %}
                        <input type="hidden" name="choice_text_{{ forloop.counter }}" id="h_text_{{ forloop.counter }}">
                        <input type="checkbox" name="is_correct_{{ forloop.counter }}" id="h_correct_{{ forloop.counter }}">
                    {% endfor %}
                </div>

                <div class="d-flex justify-content-end gap-2 mt-5 border-top pt-3">
                    <a href="{% url 'quiz:manager_quiz_list' %}" class="btn btn-secondary px-4">취소</a>
                    <button type="submit" class="btn btn-primary px-4 fw-bold">
                        {% if question %}
                            <i class="bi bi-check-lg"></i> 수정 완료
                        {% else %}
                            <i class="bi bi-plus-lg"></i> 문제 등록
                        {% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tagify/4.17.9/tagify.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tagify/4.17.9/tagify.polyfills.min.js"></script>

<script id="server-choices" type="application/json">
[
    {% for choice in question.choice_set.all %}
    { "text": "{{ choice.choice_text|escapejs }}", "is_correct": {{ choice.is_correct|yesno:"true,false" }} }{% if not forloop.last %},{% endif %}
    {% endfor %}
]
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --------------------------------------------------------
    // 1. Tagify 초기화 (태그 기능)
    // --------------------------------------------------------
    var input = document.querySelector('input[name=tags]');
    if (input) {
        new Tagify(input, {
            maxTags: 10,
            dropdown: { maxItems: 20, classname: "tags-look", enabled: 0, closeOnSelect: false }
        });
    }

    // --------------------------------------------------------
    // 2. UI 전환 및 로직
    // --------------------------------------------------------
    const typeSelect = document.getElementById('question_type');
    const uiBlocks = {
        'multiple_choice': document.getElementById('ui_choice'),
        'multiple_select': document.getElementById('ui_choice'),
        'short_answer': document.getElementById('ui_short'),
        'true_false': document.getElementById('ui_ox')
    };
    
    // 초기 데이터 로드 (수정 모드)
    const savedChoices = JSON.parse(document.getElementById('server-choices').textContent || '[]');

    function updateUI() {
        const type = typeSelect.value;
        
        // 1. 모든 UI 숨기기
        Object.values(uiBlocks).forEach(el => el.style.display = 'none');
        
        // 2. 선택된 UI 보이기
        if (uiBlocks[type]) uiBlocks[type].style.display = 'block';

        // 3. 객관식 메시지 및 라디오 동작 설정
        if (type === 'multiple_choice') {
            document.getElementById('choice_msg').innerHTML = '<i class="bi bi-exclamation-circle-fill"></i> <strong>단일 정답</strong> 모드: 정답을 1개만 선택하세요.';
            enforceRadioBehavior();
        } else if (type === 'multiple_select') {
            document.getElementById('choice_msg').innerHTML = '<i class="bi bi-info-circle-fill text-success"></i> <strong>복수 정답</strong> 모드: 정답을 2개 이상 선택하세요.';
            removeRadioBehavior();
        }
    }

    // [체크박스 제어] 하나만 선택되게 하기
    function enforceRadioBehavior() {
        const checks = document.querySelectorAll('.ui-choice-correct');
        checks.forEach(chk => {
            chk.onclick = function() {
                if (this.checked) {
                    checks.forEach(c => { if (c !== this) c.checked = false; });
                }
            };
        });
    }
    // [체크박스 제어] 여러개 선택 가능하게 하기
    function removeRadioBehavior() {
        const checks = document.querySelectorAll('.ui-choice-correct');
        checks.forEach(chk => chk.onclick = null);
    }

    // --------------------------------------------------------
    // 3. 기존 데이터 불러오기 (수정 모드일 때 UI 채우기)
    // --------------------------------------------------------
    if (savedChoices.length > 0) {
        const currentType = typeSelect.value;
        
        if (currentType === 'short_answer') {
            if (savedChoices[0]) document.getElementById('ui_short_input').value = savedChoices[0].text;
        
        } else if (currentType === 'true_false') {
            const correctChoice = savedChoices.find(c => c.is_correct);
            if (correctChoice) {
                if (correctChoice.text === 'O') document.getElementById('ui_ox_o').checked = true;
                if (correctChoice.text === 'X') document.getElementById('ui_ox_x').checked = true;
            }
        
        } else {
            // 객관식
            const textInputs = document.querySelectorAll('.ui-choice-text');
            const checkInputs = document.querySelectorAll('.ui-choice-correct');
            savedChoices.forEach((c, idx) => {
                if (idx < 4) {
                    textInputs[idx].value = c.text;
                    checkInputs[idx].checked = c.is_correct;
                }
            });
        }
    }

    // --------------------------------------------------------
    // 4. 폼 제출 시 데이터 동기화 (UI -> Hidden Fields)
    // --------------------------------------------------------
    document.getElementById('questionForm').addEventListener('submit', function(e) {
        const type = typeSelect.value;
        
        // 숨겨진 필드 일단 초기화
        for(let i=1; i<=4; i++) {
            document.getElementById(`h_text_${i}`).value = '';
            document.getElementById(`h_correct_${i}`).checked = false;
        }

        if (type === 'short_answer') {
            // [주관식] 입력값 -> 1번 보기에 저장
            const val = document.getElementById('ui_short_input').value.trim();
            if(!val) { alert('정답 단어를 입력하세요!'); e.preventDefault(); return; }
            
            document.getElementById('h_text_1').value = val;
            document.getElementById('h_correct_1').checked = true;

        } else if (type === 'true_false') {
            // [OX] O/X 선택 -> 1번(O), 2번(X) 보기에 분배 저장
            const o = document.getElementById('ui_ox_o').checked;
            const x = document.getElementById('ui_ox_x').checked;
            if (!o && !x) { alert('O 또는 X 중 정답을 선택하세요!'); e.preventDefault(); return; }

            document.getElementById('h_text_1').value = 'O';
            document.getElementById('h_correct_1').checked = o;
            
            document.getElementById('h_text_2').value = 'X';
            document.getElementById('h_correct_2').checked = x;

        } else {
            // [객관식/다중] UI 입력값 -> 1~4번 보기에 그대로 저장
            const texts = document.querySelectorAll('.ui-choice-text');
            const checks = document.querySelectorAll('.ui-choice-correct');
            let checkedCount = 0;

            texts.forEach((input, idx) => {
                const hiddenText = document.getElementById(`h_text_${idx+1}`);
                const hiddenCheck = document.getElementById(`h_correct_${idx+1}`);
                
                hiddenText.value = input.value.trim();
                hiddenCheck.checked = checks[idx].checked;
                
                if (checks[idx].checked) checkedCount++;
            });

            if (checkedCount === 0) { alert('정답을 최소 1개 이상 선택해야 합니다.'); e.preventDefault(); return; }
            if (type === 'multiple_choice' && checkedCount > 1) { alert('객관식(단일)은 정답이 1개여야 합니다.'); e.preventDefault(); return; }
        }
    });

    // 이벤트 리스너 시작
    typeSelect.addEventListener('change', updateUI);
    updateUI(); // 초기 실행
});
</script>
{% endblock %}