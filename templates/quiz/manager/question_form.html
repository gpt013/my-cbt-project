{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />

<style>
    /* [1] 보기(Choice) 입력 영역 스타일 */
    .choice-row {
        transition: all 0.2s ease-in-out;
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        margin-bottom: 10px; /* 보기 사이 간격 */
    }
    .choice-row:hover {
        transform: translateY(-2px);
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.08) !important;
        border-color: #86b7fe;
    }

    /* 보기 번호 (좌측) */
    .choice-label-box {
        width: 100px;
        background-color: #f8f9fa;
        color: #495057;
        font-weight: 700;
        border-right: 1px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* 정답 체크 영역 (우측) */
    .choice-check-box {
        width: 100px;
        background-color: #fff;
        border-left: 1px solid #dee2e6;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
    }
    .choice-check-box:hover {
        background-color: #f0fff4; /* 살짝 초록빛 */
    }

    /* 입력 필드 커스텀 */
    .custom-input {
        border: none;
        box-shadow: none;
    }
    .custom-input:focus {
        box-shadow: none;
        background-color: #fcfcfc;
    }

    /* Tagify 커스텀 */
    .tagify {
        width: 100%;
        border-radius: 0.375rem;
        --tags-border-color: #dee2e6;
        --tags-focus-border-color: #86b7fe;
    }

    .form-label { font-weight: 700; color: #212529; margin-bottom: 0.5rem; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5 mb-5" style="max-width: 900px;">
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
            <h4 class="mb-0 text-primary fw-bold">
                {% if question %}
                    <i class="bi bi-pencil-square me-2"></i>문제 수정
                {% else %}
                    <i class="bi bi-plus-lg me-2"></i>새 문제 추가
                {% endif %}
            </h4>
            {% if quiz %}
                <span class="badge bg-primary bg-opacity-10 text-primary border border-primary px-3 py-2">
                    시험: {{ quiz.title }}
                </span>
            {% endif %}
        </div>
        
        <div class="card-body p-4 p-md-5">
            <form method="post" enctype="multipart/form-data" id="questionForm">
                {% csrf_token %}
                
                {% if quiz %}
                    <input type="hidden" name="quiz_id" value="{{ quiz.id }}">
                {% endif %}
                
                <h5 class="fw-bold text-secondary mb-4 border-bottom pb-2">
                    <i class="bi bi-info-circle me-1"></i> 문제 정보
                </h5>
                
                <div class="mb-4">
                    <label for="question_text" class="form-label">문제 내용 <span class="text-danger">*</span></label>
                    <textarea name="question_text" id="question_text" class="form-control" rows="3" placeholder="문제를 입력하세요" required>{{ question.question_text|default:'' }}</textarea>
                </div>

                <div class="mb-4">
                    <label class="form-label">이미지 (선택)</label>
                    <input type="file" name="question_image" class="form-control" accept="image/*">
                    {% if question.image %}
                        <div class="mt-2 p-2 border rounded d-inline-block bg-light">
                            <img src="{{ question.image.url }}" style="height: 100px; border-radius: 4px;" class="me-2">
                            <span class="badge bg-secondary">현재 이미지</span>
                        </div>
                    {% endif %}
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <label for="id_question_type" class="form-label">유형</label>
                        <select name="question_type" id="id_question_type" class="form-select">
                            <option value="multiple_choice" {% if question.question_type == 'multiple_choice' %}selected{% endif %}>4지선다 (객관식)</option>
                            <option value="multiple_select" {% if question.question_type == 'multiple_select' %}selected{% endif %}>다중선택</option>
                            <option value="short_answer" {% if question.question_type == 'short_answer' %}selected{% endif %}>주관식 (단답형)</option>
                            <option value="true_false" {% if question.question_type == 'true_false' %}selected{% endif %}>OX 퀴즈</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="difficulty" class="form-label">난이도</label>
                        <select name="difficulty" id="difficulty" class="form-select">
                            <option value="1" {% if question.difficulty == 1 %}selected{% endif %}>하</option>
                            <option value="2" {% if question.difficulty == 2 %}selected{% endif %}>중</option>
                            <option value="3" {% if question.difficulty == 3 %}selected{% endif %}>상</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label">태그 선택</label>
                    <input name="tags" id="tags" class="form-control" placeholder="태그 입력 후 엔터..." value="{{ current_tags|default:'' }}">
                    <div class="form-text text-muted mt-1">
                        <i class="bi bi-check2-all"></i> 입력 후 엔터를 치거나 자동완성 목록에서 선택하세요.
                    </div>
                </div>

                <h5 class="fw-bold text-secondary mb-4 border-bottom pb-2 mt-5">
                    <i class="bi bi-check2-square me-1"></i> 보기 및 정답 설정
                </h5>

                <div id="choice-section">
                    <div class="vstack">
                        {% if choices %}
                            {% for choice in choices %}
                                <div class="d-flex choice-row">
                                    <div class="choice-label-box rounded-start">보기 {{ forloop.counter }}</div>
                                    <div class="flex-grow-1 p-2">
                                        <input type="text" name="choice_text_{{ forloop.counter }}" class="form-control custom-input mb-2" value="{{ choice.choice_text }}" placeholder="보기 내용을 입력하세요">
                                        <div class="d-flex align-items-center gap-2">
                                            <input type="file" name="choice_image_{{ forloop.counter }}" class="form-control form-control-sm w-50" accept="image/*">
                                            {% if choice.image %}
                                                <a href="{{ choice.image.url }}" target="_blank" class="badge bg-secondary text-decoration-none">이미지 있음</a>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="choice-check-box rounded-end" onclick="toggleCheckbox(this)">
                                        <div class="form-check form-switch m-0 d-flex flex-column align-items-center">
                                            <input class="form-check-input fs-5" type="checkbox" name="is_correct_{{ forloop.counter }}" {% if choice.is_correct %}checked{% endif %}>
                                            <label class="form-check-label mt-1">정답</label>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                            
                            {% if choices|length < 4 %}
                                {% with start=choices|length|add:"1" %}
                                    {% for i in "x"|rjust:"4"|make_list %}
                                        {% if forloop.counter >= start %}
                                            <div class="d-flex choice-row">
                                                <div class="choice-label-box rounded-start">보기 {{ forloop.counter }}</div>
                                                <div class="flex-grow-1 p-2">
                                                    <input type="text" name="choice_text_{{ forloop.counter }}" class="form-control custom-input mb-2" placeholder="보기 내용을 입력하세요">
                                                    <input type="file" name="choice_image_{{ forloop.counter }}" class="form-control form-control-sm w-50" accept="image/*">
                                                </div>
                                                <div class="choice-check-box rounded-end" onclick="toggleCheckbox(this)">
                                                    <div class="form-check form-switch m-0 d-flex flex-column align-items-center">
                                                        <input class="form-check-input fs-5" type="checkbox" name="is_correct_{{ forloop.counter }}">
                                                        <label class="form-check-label mt-1">정답</label>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                {% endwith %}
                            {% endif %}
                        {% else %}
                            {% for i in "1234" %}
                                <div class="d-flex choice-row">
                                    <div class="choice-label-box rounded-start">보기 {{ forloop.counter }}</div>
                                    <div class="flex-grow-1 p-2">
                                        <input type="text" name="choice_text_{{ forloop.counter }}" class="form-control custom-input mb-2" placeholder="보기 내용을 입력하세요">
                                        <input type="file" name="choice_image_{{ forloop.counter }}" class="form-control form-control-sm w-50" accept="image/*">
                                    </div>
                                    <div class="choice-check-box rounded-end" onclick="toggleCheckbox(this)">
                                        <div class="form-check form-switch m-0 d-flex flex-column align-items-center">
                                            <input class="form-check-input fs-5" type="checkbox" name="is_correct_{{ forloop.counter }}">
                                            <label class="form-check-label mt-1">정답</label>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <div class="alert alert-light border mt-4 small text-secondary">
                        <i class="bi bi-info-circle-fill text-info me-1"></i> 객관식은 정답 1개, 다중선택은 2개 이상 체크하세요. 텍스트 대신 이미지를 넣을 수도 있습니다.
                    </div>
                </div>

                <div id="short-answer-section" style="display: none;">
                    <div class="bg-light p-4 rounded border">
                        <label class="form-label fw-bold">정답 단어 입력</label>
                        <input type="text" name="correct_answer_text" class="form-control form-control-lg" value="{{ short_answer_val|default:'' }}" placeholder="예: 반도체, 에칭 (여러 개일 경우 쉼표로 구분)">
                        <div class="form-text text-muted mt-2">
                            * 띄어쓰기나 대소문자는 채점 시 자동으로 보정됩니다. 복수 정답 허용 시 쉼표(,)로 구분하세요.
                        </div>
                    </div>
                </div>

                <div id="ox-section" style="display: none;">
                    <div class="d-flex gap-3 justify-content-center p-4 bg-light rounded border">
                        <div class="text-center w-25">
                            <input type="radio" class="btn-check" name="ox_answer" id="ox_o" value="O" autocomplete="off" {% if ox_answer_val == 'O' %}checked{% endif %}>
                            <label class="btn btn-outline-success w-100 py-3 fw-bold rounded-3" for="ox_o">
                                <span class="fs-2">O</span><br>그렇다
                            </label>
                        </div>
                        <div class="text-center w-25">
                            <input type="radio" class="btn-check" name="ox_answer" id="ox_x" value="X" autocomplete="off" {% if ox_answer_val == 'X' %}checked{% endif %}>
                            <label class="btn btn-outline-danger w-100 py-3 fw-bold rounded-3" for="ox_x">
                                <span class="fs-2">X</span><br>아니다
                            </label>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end gap-2 mt-5 pt-3 border-top">
                    <a href="javascript:history.back()" class="btn btn-lg btn-secondary px-4 fw-bold">취소</a>
                    <button type="submit" class="btn btn-lg btn-primary px-5 fw-bold">
                        <i class="bi bi-save me-1"></i> 저장하기
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Tagify 설정 (태그 자동완성)
        var input = document.querySelector('input[name=tags]');
        // 뷰에서 전달받은 tags_whitelist를 JSON으로 파싱
        var whitelist = JSON.parse('{{ tags_whitelist|safe|default:"[]" }}');
        
        new Tagify(input, {
            whitelist: whitelist,
            maxTags: 10,
            dropdown: { 
                maxItems: 20, 
                classname: "tags-look", 
                enabled: 0, // 0: 클릭하자마자 드롭다운 표시
                closeOnSelect: false 
            }
        });

        // 2. 화면 전환 로직 (유형 선택 시 입력창 변경)
        const typeSelect = document.getElementById('id_question_type');
        const sections = {
            'choice': document.getElementById('choice-section'),
            'short': document.getElementById('short-answer-section'),
            'ox': document.getElementById('ox-section')
        };

        function updateForm() {
            const val = typeSelect.value;
            // 모든 섹션 일단 숨김
            Object.values(sections).forEach(el => el.style.display = 'none'); 

            if (val === 'multiple_choice' || val === 'multiple_select') {
                sections['choice'].style.display = 'block';
            } else if (val === 'short_answer') {
                sections['short'].style.display = 'block';
            } else if (val === 'true_false') {
                sections['ox'].style.display = 'block';
            }
        }
        
        updateForm();
        typeSelect.addEventListener('change', updateForm);
    });

    // 3. 체크박스 영역 클릭 시 토글 (UX 개선)
    function toggleCheckbox(div) {
        // 실제 체크박스를 직접 클릭했을 때는 중복 이벤트 방지
        if (event.target.type === 'checkbox') return;
        
        const chk = div.querySelector('input[type="checkbox"]');
        if (chk) chk.checked = !chk.checked;
    }
</script>
{% endblock %}