{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    /* [ë§ˆìŠ¤í„° ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆ] - ì „ì²´ í™”ë©´ ë†’ì´ í™œìš© & ìŠ¤í¬ë¡¤ ì˜ì—­ ì§€ì • */
    .master-grid-container {
        position: relative;
        /* ìƒë‹¨ í—¤ë”, í•„í„°ë°” ë†’ì´ë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ì˜ì—­ì„ ê½‰ ì±„ì›€ */
        height: calc(100vh - 240px); 
        width: 100%;
        overflow: auto; /* ê°€ë¡œ/ì„¸ë¡œ ìŠ¤í¬ë¡¤ ìë™ í™œì„±í™” */
        border: 1px solid #aaa;
        background-color: #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* [í…Œì´ë¸” ê¸°ë³¸ ì„¤ì •] */
    .excel-table {
        width: max-content; /* ë‚´ìš©ë¬¼ë§Œí¼ ë„ˆë¹„ í™•ë³´ (ê°€ë¡œ ìŠ¤í¬ë¡¤ ìœ ë„) */
        min-width: 100%;    /* ìµœì†Œ í™”ë©´ ë„ˆë¹„ */
        border-collapse: separate; /* Sticky ê³ ì • ì‹œ í…Œë‘ë¦¬ ê¹¨ì§ ë°©ì§€ */
        border-spacing: 0;
        font-size: 13px;
        white-space: nowrap; /* ì¤„ë°”ê¿ˆ ì ˆëŒ€ ê¸ˆì§€ */
        table-layout: fixed; /* ì¹¸ ë„ˆë¹„ ê³ ì • */
    }

    .excel-table th, .excel-table td {
        padding: 6px 10px;
        border-right: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        vertical-align: middle;
        box-sizing: border-box;
        background-color: #fff; /* ê¸°ë³¸ ë°°ê²½ í°ìƒ‰ */
        text-align: center;
        height: 35px; /* í–‰ ë†’ì´ ê· ì¼í™” */
    }

    /* ----------------------------------------------------
       [Sticky ê³ ì • ë° ë°°ê²½ìƒ‰ ë¶ˆíˆ¬ëª… ì²˜ë¦¬]
       z-index ê³„ì¸µ:
       30: ì¢Œì¸¡ìƒë‹¨/ìš°ì¸¡ìƒë‹¨ ëª¨ì„œë¦¬ (ìµœìƒìœ„)
       20: ìƒë‹¨ í—¤ë”
       10: ì¢Œì¸¡/ìš°ì¸¡ ê³ ì • ì»¬ëŸ¼
    ---------------------------------------------------- */

    /* 1. ìƒë‹¨ í—¤ë” ê³ ì • (ë°°ê²½ íšŒìƒ‰) */
    .excel-table thead { position: sticky; top: 0; z-index: 20; }
    
    /* í—¤ë” 1ë²ˆì§¸ ì¤„ */
    .excel-table thead tr:nth-child(1) th { 
        position: sticky; top: 0; height: 38px; 
        background-color: #e9ecef !important; 
        border-top: 1px solid #ccc; 
    }
    /* í—¤ë” 2ë²ˆì§¸ ì¤„ */
    .excel-table thead tr:nth-child(2) th { 
        position: sticky; top: 38px; height: 32px; 
        background-color: #f8f9fa !important; 
    }

    /* 2. ì¢Œì¸¡ ê³ ì • ì»¬ëŸ¼ (ì´ë¦„) */
    .col-fix-name { 
        position: sticky; left: 0; z-index: 10; 
        width: 100px; min-width: 100px; /* ë„‰ë„‰í•˜ê²Œ */
        background-color: #fff !important; 
        border-right: 2px solid #999 !important; 
    }
    
    /* 3. ì¢Œì¸¡ ê³ ì • ì»¬ëŸ¼ (ì •ë³´) */
    .col-fix-info { 
        position: sticky; left: 100px; z-index: 10; 
        width: 140px; min-width: 140px; 
        background-color: #fff !important; 
        border-right: 2px solid #999 !important; 
    }

    /* 4. í—¤ë”ì™€ ê³ ì • ì»¬ëŸ¼ì´ ê²¹ì¹˜ëŠ” ë¶€ë¶„ (ìµœìƒìœ„) */
    .excel-table thead th.col-fix-name, 
    .excel-table thead th.col-fix-info { 
        z-index: 30; 
        background-color: #dee2e6 !important; 
    }

    /* 5. ìš°ì¸¡ ê³ ì • ì»¬ëŸ¼ (ê´€ë¦¬ ë²„íŠ¼) */
    .col-fix-action { 
        position: sticky; right: 0; z-index: 10; 
        width: 70px; min-width: 70px;
        background-color: #fff !important; 
        border-left: 2px solid #999 !important; 
    }
    .excel-table thead th.col-fix-action { 
        z-index: 30; 
        background-color: #dee2e6 !important; 
    }

    /* [Hover íš¨ê³¼] - ê³ ì • ì»¬ëŸ¼ì€ ë°°ê²½ìƒ‰ í°ìƒ‰ ìœ ì§€ */
    .excel-table tbody tr:hover td { background-color: #e8f0fe; }
    .excel-table tbody tr:hover td.col-fix-name,
    .excel-table tbody tr:hover td.col-fix-info,
    .excel-table tbody tr:hover td.col-fix-action { background-color: #fff !important; }

    /* [ì…€ ìŠ¤íƒ€ì¼] */
    /* ì ìˆ˜ ì¹¸ ë„ˆë¹„ (99.99ì  í‘œì‹œ ê°€ëŠ¥í•˜ë„ë¡ 60px í™•ë³´) */
    .cell-score { width: 60px; min-width: 60px; text-align: right; padding-right: 8px; font-variant-numeric: tabular-nums; }
    
    /* ìƒíƒœ ë±ƒì§€ ë“± */
    .pass { color: blue; font-weight: bold; background-color: #f0f8ff !important; }
    .fail { color: red; font-weight: bold; background-color: #fff0f0 !important; }
    .border-l-thick { border-left: 2px solid #bbb !important; }
    
    /* ì„ì°¨ ì»¬ëŸ¼ */
    .rank-col { width: 55px; min-width: 55px; background-color: #fdfdfe !important; font-size: 0.85rem; }
    .rank-top { color: #d63384; font-weight: bold; } 
    
    .badge { font-weight: 500; letter-spacing: 0.5px; }
</style>

<div class="container-fluid py-3">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 class="fw-bold mb-0"><i class="bi bi-table"></i> ë§ˆìŠ¤í„° ë°ì´í„° ê·¸ë¦¬ë“œ</h4>
            <span class="text-muted small">ëª¨ë“  êµìœ¡ìƒì˜ ì„±ì , ê·¼íƒœ, í‰ê°€ ë° ìƒì„¸ ì„ì°¨ë¥¼ ì—‘ì…€ í˜•ì‹ìœ¼ë¡œ ì¡°íšŒí•©ë‹ˆë‹¤.</span>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <span class="badge bg-dark fs-6 shadow-sm">Total: {{ total_count|default:"0" }}ëª…</span>
            <button class="btn btn-success fw-bold shadow-sm" onclick="downloadCurrentFilter()">
                <i class="fas fa-file-excel"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
            </button>
        </div>
    </div>

    <div class="card mb-3 border bg-light shadow-sm">
        <div class="card-body py-2">
            <form method="get" class="row g-2 align-items-end">
                <div class="col-auto">
                    <label class="form-label small fw-bold mb-0 text-secondary">ğŸ“… ì…ê³¼ì¼</label>
                    <div class="input-group input-group-sm">
                        <input type="date" name="start_date" class="form-control" value="{{ sel_start }}">
                        <span class="input-group-text">~</span>
                        <input type="date" name="end_date" class="form-control" value="{{ sel_end }}">
                    </div>
                </div>
                <div class="col-auto">
                    <label class="form-label small fw-bold mb-0 text-secondary">ğŸ¢ íšŒì‚¬</label>
                    <select name="company" class="form-select form-select-sm" style="min-width: 120px;">
                        <option value="">ì „ì²´</option>
                        {% for c in companies %}
                            <option value="{{ c.id }}" {% if sel_company == c.id %}selected{% endif %}>{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-auto">
                    <label class="form-label small fw-bold mb-0 text-secondary">âš™ï¸ ê³µì •</label>
                    <select name="process" class="form-select form-select-sm">
                        <option value="">ì „ì²´</option>
                        {% for p in processes %}
                            <option value="{{ p.id }}" {% if sel_process == p.id %}selected{% endif %}>{{ p.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-auto">
                    <label class="form-label small fw-bold mb-0 text-secondary">ğŸ“ ê¸°ìˆ˜</label>
                    <select name="cohort" class="form-select form-select-sm">
                        <option value="">ì „ì²´</option>
                        {% for c in cohorts %}
                            <option value="{{ c.id }}" {% if sel_cohort == c.id %}selected{% endif %}>{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-auto">
                    <label class="form-label small fw-bold mb-0 text-secondary">ğŸ” ê²€ìƒ‰</label>
                    <input type="text" name="q" class="form-control form-control-sm" placeholder="ì´ë¦„/ID/ì‚¬ë²ˆ" value="{{ sel_q }}">
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary btn-sm px-3 fw-bold">ì¡°íšŒ</button>
                    <a href="{% url 'quiz:admin_full_data_view' %}" class="btn btn-outline-secondary btn-sm">ì´ˆê¸°í™”</a>
                </div>
            </form>
        </div>
    </div>

    <div class="master-grid-container">
        <table class="excel-table">
            <thead>
                <tr>
                    <th rowspan="2" class="col-fix-name">ì´ë¦„</th>
                    <th rowspan="2" class="col-fix-info">ì •ë³´</th>
                    
                    <th rowspan="2" style="width: 80px; min-width: 80px;">ìƒíƒœ</th>
                    <th rowspan="2" class="border-l-thick" style="width: 100px; min-width: 100px;">ê·¼íƒœ<br>(ì¶œ/ì—°/ë°˜)</th>
                    <th rowspan="2" class="text-danger" style="width: 60px; min-width: 60px;">ê²½ê³ </th>

                    {% for q in quizzes %}
                        <th colspan="3" class="border-l-thick bg-light" style="background-color: #f8f9fa !important; min-width: 180px;">{{ q.title }}</th>
                    {% endfor %}

                    <th colspan="5" class="border-l-thick" style="background-color: #fff3cd !important;">ì¢…í•© ì ìˆ˜</th>
                    
                    <th colspan="4" class="border-l-thick" style="background-color: #e2e3e5 !important;">ì„ì°¨ ì •ë³´</th>
                    
                    <th rowspan="2" class="col-fix-action">ê´€ë¦¬</th>
                </tr>

                <tr>
                    {% for q in quizzes %}
                        <th class="text-muted border-l-thick small">1ì°¨</th>
                        <th class="text-muted small">2ì°¨</th>
                        <th class="text-muted small">3ì°¨</th>
                    {% endfor %}

                    <th class="border-l-thick small" style="min-width: 70px;">ì‹œí—˜Avg</th>
                    <th class="small" style="min-width: 60px;">ì‹¤ìŠµ</th>
                    <th class="small" style="min-width: 60px;">ë…¸íŠ¸</th>
                    <th class="small" style="min-width: 60px;">íƒœë„</th>
                    <th class="fw-bold bg-warning bg-opacity-25 small" style="min-width: 70px;">ì´ì </th>

                    <th class="border-l-thick rank-col" title="ì „ì²´ ì¸ì› ì¤‘ ì„ì°¨">ì „ì²´</th>
                    <th class="rank-col" title="ê°™ì€ ê¸°ìˆ˜ ë‚´ ì„ì°¨">ê¸°ìˆ˜</th>
                    <th class="rank-col" title="ê°™ì€ ê³µì • ë‚´ ì„ì°¨">ê³µì •</th>
                    <th class="rank-col" title="ê°™ì€ íšŒì‚¬ ë‚´ ì„ì°¨">íšŒì‚¬</th>
                </tr>
            </thead>
            <tbody>
                {% for row in table_rows %}
                <tr>
                    <td class="col-fix-name fw-bold text-primary">{{ row.profile.name|default:"(ì—†ìŒ)" }}</td>
                    
                    <td class="col-fix-info">
                        <div class="d-flex flex-column" style="line-height: 1.2;">
                            <span class="text-dark fw-bold" style="font-size: 11px;">{{ row.profile.company.name|default:"-" }}</span>
                            <span class="text-muted" style="font-size: 11px;">{{ row.profile.employee_id|default:"-" }}</span>
                            <span class="badge bg-light text-dark border mt-1" style="font-size: 10px;">{{ row.profile.process.name|default:"ë¯¸ë°°ì •" }}</span>
                        </div>
                    </td>

                    <td>
                        {% if row.profile.status == 'attending' %}<span class="badge bg-success">ì¬ì§</span>
                        {% elif row.profile.status == 'counseling' %}<span class="badge bg-warning text-dark">ë©´ë‹´</span>
                        {% elif row.profile.status == 'dropout' %}<span class="badge bg-danger">í‡´ì†Œ</span>
                        {% else %}<span class="badge bg-secondary">ìˆ˜ë£Œ</span>{% endif %}
                    </td>

                    <td class="border-l-thick">
                        {{ row.attendance.work }} / 
                        <span class="{% if row.attendance.leave > 0 %}text-danger fw-bold{% endif %}">{{ row.attendance.leave }}</span> / 
                        {{ row.attendance.half }}
                    </td>

                    <td class="fw-bold {% if row.profile.warning_count > 0 %}text-danger{% else %}text-muted{% endif %}">
                        {{ row.profile.warning_count }}
                    </td>

                    {% for score_set in row.ordered_scores %}
                        <td class="cell-score border-l-thick {% if score_set.0.is_pass %}pass{% elif score_set.0.val != '-' %}fail{% endif %}">
                            {% if score_set.0.val != '-' %}{{ score_set.0.val|floatformat:2 }}{% else %}-{% endif %}
                        </td>
                        <td class="cell-score {% if score_set.1.is_pass %}pass{% elif score_set.1.val != '-' %}fail{% endif %}">
                            {% if score_set.1.val != '-' %}{{ score_set.1.val|floatformat:2 }}{% else %}-{% endif %}
                        </td>
                        <td class="cell-score {% if score_set.2.is_pass %}pass{% elif score_set.2.val != '-' %}fail{% endif %}">
                            {% if score_set.2.val != '-' %}{{ score_set.2.val|floatformat:2 }}{% else %}-{% endif %}
                        </td>
                    {% endfor %}

                    <td class="border-l-thick">{{ row.final.exam_avg_score|default:"-"|floatformat:2 }}</td>
                    <td>{{ row.final.practice_score|default:"-"|floatformat:2 }}</td>
                    <td>{{ row.final.note_score|default:"-"|floatformat:2 }}</td>
                    <td>{{ row.final.attitude_score|default:"-"|floatformat:2 }}</td>
                    <td class="fw-bold" style="background-color: #fff3cd;">{{ row.final.final_score|default:"-"|floatformat:2 }}</td>

                    <td class="border-l-thick rank-col fw-bold {% if row.ranks.overall <= 3 %}rank-top{% endif %}">
                        {{ row.ranks.overall|default:"-" }}
                    </td>
                    <td class="rank-col">{{ row.ranks.cohort|default:"-" }}</td>
                    <td class="rank-col">{{ row.ranks.process|default:"-" }}</td>
                    <td class="rank-col">{{ row.ranks.company|default:"-" }}</td>

                    <td class="col-fix-action">
                        <button type="button" class="btn btn-outline-secondary btn-sm py-0 px-1" 
                                data-bs-toggle="modal" data-bs-target="#detailModal{{ row.profile.id }}">
                            <i class="bi bi-file-text"></i>
                        </button>
                    </td>
                </tr>

                <div class="modal fade" id="detailModal{{ row.profile.id }}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header bg-light">
                                <h5 class="modal-title fw-bold">
                                    <i class="bi bi-person-lines-fill"></i> {{ row.profile.name }} ìƒì„¸ ê¸°ë¡
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="p-3 border rounded bg-light h-100">
                                            <h6 class="fw-bold text-primary">ê¸°ë³¸ ì •ë³´</h6>
                                            <ul class="list-unstyled small mb-0">
                                                <li>â€¢ ì…ê³¼ì¼: {{ row.profile.joined_at|date:"Y-m-d"|default:"-" }}</li>
                                                <li>â€¢ ì—°ë½ì²˜: {{ row.profile.phone|default:"-" }}</li>
                                                <li>â€¢ ì´ë©”ì¼: {{ row.profile.user.email }}</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="p-3 border rounded bg-light h-100">
                                            <h6 class="fw-bold text-success">ë§¤ë‹ˆì € ì½”ë©˜íŠ¸</h6>
                                            <p class="small mb-0 fst-italic">
                                                {{ row.manager_comment|default:"ë“±ë¡ëœ ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤."|linebreaksbr }}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <h6 class="fw-bold text-danger border-bottom pb-2">ğŸš© íŠ¹ì´ì‚¬í•­ íˆìŠ¤í† ë¦¬</h6>
                                {% if row.logs %}
                                    <ul class="list-group list-group-flush">
                                        {% for log in row.logs %}
                                            <li class="list-group-item px-0">
                                                <div class="d-flex justify-content-between">
                                                    <span class="badge bg-secondary">{{ log.get_log_type_display }}</span>
                                                    <small class="text-muted">{{ log.created_at|date:"Y-m-d" }}</small>
                                                </div>
                                                <p class="mb-1 mt-1 small fw-bold">{{ log.reason }}</p>
                                                {% if log.action_taken %}
                                                    <div class="bg-light p-2 rounded small">â”” ì¡°ì¹˜: {{ log.action_taken }}</div>
                                                {% endif %}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p class="text-center text-muted small py-3">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                {% endif %}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <tr><td colspan="100" class="text-center py-5">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function downloadCurrentFilter() {
        const params = new URLSearchParams(window.location.search);
        // ë‹¤ìš´ë¡œë“œìš© process_id ë³´ì •
        if (!params.has('process_id')) {
            if (params.has('process')) {
                params.set('process_id', params.get('process'));
            } else {
                params.set('process_id', 'ALL');
            }
        }
        location.href = "{% url 'quiz:export_student_data' %}?" + params.toString();
    }
</script>
{% endblock %}