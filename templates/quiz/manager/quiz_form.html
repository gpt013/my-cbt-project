{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4" style="max-width: 700px;">
    <div class="card shadow border-0">
        <div class="card-header bg-white py-3">
            <h4 class="fw-bold mb-0 text-primary">
                {% if form.instance.pk %}
                    <i class="bi bi-gear-fill"></i> 시험 설정 수정
                {% else %}
                    <i class="bi bi-plus-circle-fill"></i> 새 시험 생성
                {% endif %}
            </h4>
        </div>
        <div class="card-body p-4">
            <form method="post">
                {% csrf_token %}
                
                <div class="mb-4">
                    <label class="form-label fw-bold">시험 제목</label>
                    {{ form.title }}
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">분류</label>
                        {{ form.category }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">관련 공정</label>
                        {{ form.associated_process }}
                        <div class="form-text small">공정 시험인 경우 필수로 선택하세요.</div>
                    </div>
                </div>

                <div class="mb-4 bg-light p-3 rounded border">
                    <label class="form-label fw-bold"><i class="bi bi-shuffle"></i> 문제 출제 방식</label>
                    {{ form.generation_method }} <div class="form-text mt-2 text-dark small">
                        <ul class="mb-0 ps-3">
                            <li><strong>랜덤:</strong> 등록된 문제 중 난이도 비율(상/중/하)에 맞춰 무작위 출제</li>
                            <li><strong>태그:</strong> 아래 '필수 태그'를 가진 문제들 중에서만 무작위 출제</li>
                            <li><strong>지정:</strong> 매니저가 지정한 문제들로만 고정된 시험지를 구성</li>
                        </ul>
                    </div>

                    <div id="fixedSetSection" class="mt-3" style="display: none;">
                        <div class="alert alert-primary d-flex align-items-start">
                            <i class="bi bi-info-circle-fill me-2 mt-1"></i>
                            <div>
                                <strong>'지정(Fixed)' 방식</strong>을 선택하셨습니다.<br>
                                <span class="small">이 방식은 매니저가 등록한 문제 리스트 그대로 출제됩니다.</span>
                            </div>
                        </div>

                        {% if form.instance.pk %}
                            <div class="d-grid">
                                <a href="{% url 'quiz:question_list' form.instance.pk %}" class="btn btn-outline-primary fw-bold" target="_blank">
                                    <i class="bi bi-list-check"></i> 지정 문제(세트) 구성하러 가기
                                </a>
                                <div class="form-text text-center mt-1">
                                    * 새 창에서 문제가 열립니다. 문제를 추가/삭제하여 세트를 완성하세요.
                                </div>
                            </div>
                        {% else %}
                            <div class="alert alert-warning small mb-0">
                                <strong>알림:</strong> 시험을 먼저 <strong>[저장하기]</strong> 한 후에 문제를 구성할 수 있습니다.
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="mb-3" id="tagSection">
                    <label class="form-label fw-bold">필수 태그 (태그 방식용)</label>
                    {{ form.required_tags }}
                    <div class="form-text">Ctrl (Mac은 Cmd) 키를 누르고 클릭하면 다중 선택 가능</div>
                </div>

                <hr class="my-4">

                <div class="d-flex justify-content-end gap-2">
                    <a href="{% url 'quiz:manager_quiz_list' %}" class="btn btn-secondary">취소</a>
                    <button type="submit" class="btn btn-primary px-4 fw-bold">
                        <i class="bi bi-check-lg"></i> 저장하기
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const methodSelect = document.getElementById('id_generation_method');
        const fixedSection = document.getElementById('fixedSetSection');
        const tagSection = document.getElementById('tagSection');

        function toggleSections() {
            const value = methodSelect.value;
            
            // 1. 지정(Fixed) 방식일 때
            // DB에 저장되는 값이 '지정'인지 'fixed'인지 확인 필요. 
            // 보통 한글 설정이면 '지정', 코드 설정이면 'fixed'입니다. 둘 다 체크합니다.
            if (value === '지정' || value === 'fixed') {
                fixedSection.style.display = 'block';
                tagSection.style.opacity = '0.5'; // 태그 섹션 흐리게 (비활성 느낌)
            } else {
                fixedSection.style.display = 'none';
                tagSection.style.opacity = '1';
            }

            // 2. 태그(Tag) 방식일 때 강조 (선택 사항)
            if (value === '태그' || value === 'tag') {
                tagSection.style.border = '2px solid #0d6efd';
                tagSection.style.padding = '10px';
                tagSection.style.borderRadius = '5px';
            } else {
                tagSection.style.border = 'none';
                tagSection.style.padding = '0';
            }
        }

        if (methodSelect) {
            methodSelect.addEventListener('change', toggleSections);
            // 초기 실행
            toggleSections();
        }
    });
</script>
{% endblock %}