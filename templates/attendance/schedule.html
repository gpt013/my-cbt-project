{% extends 'base.html' %}
{% load static custom_tags %}

{% block content %}
<style>
    /* 1. í…Œì´ë¸” ì»¨í…Œì´ë„ˆ */
    .schedule-table-container { 
        overflow: auto; 
        max-height: 70vh; 
        position: relative; 
        border: 1px solid #dee2e6;
        border-radius: 8px;
        transition: border-color 0.3s;
        background: #fff;
    }
    
    .schedule-table-container.edit-mode-active {
        border: 2px solid #0d6efd;
        box-shadow: 0 0 15px rgba(13, 110, 253, 0.15);
    }

    /* 2. í…Œì´ë¸” ì…€ ìŠ¤íƒ€ì¼ */
    .schedule-table th, .schedule-table td { 
        white-space: nowrap; 
        text-align: center; 
        vertical-align: middle; 
        padding: 4px 2px; 
        border: 1px solid #eee; 
        min-width: 45px; 
        font-size: 0.85em; 
    }

    /* 3. Sticky Header (ìƒë‹¨ ê³ ì •) */
    .schedule-table thead th { 
        position: sticky; top: 0; background-color: #f8f9fa; z-index: 10; 
        border-bottom: 2px solid #dee2e6;
    }

    /* 4. Sticky Column (ì™¼ìª½ ì´ë¦„ ê³ ì •) */
    .schedule-table tbody th { 
        position: sticky; left: 0; background-color: #fff; z-index: 5; 
        border-right: 2px solid #dee2e6; min-width: 100px;
    }
    .schedule-table thead th:first-child { 
        left: 0; z-index: 20; background-color: #e9ecef; border-right: 2px solid #dee2e6;
    }

    /* 5. ë‚ ì§œ ìŠ¤íƒ€ì¼ */
    .today-col { background-color: #fff3cd !important; border-left: 2px solid #ffc107 !important; border-right: 2px solid #ffc107 !important; font-weight: bold; }
    .holiday-col { color: #dc3545; background-color: #fff0f0; } 
    .sat-col { color: #0d6efd; background-color: #f0f8ff; }

    /* 6. ê·¼ë¬´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (2ì¤„ ì„¸ë¡œ ì •ë ¬) */
    .type-btn { 
        width: 42px; height: 42px; 
        border-radius: 6px; 
        border: 1px solid #ced4da; 
        cursor: not-allowed; opacity: 0.6;
        
        /* [ë””ìì¸ í•µì‹¬] í…ìŠ¤íŠ¸ ìœ„ì•„ë˜ ì •ë ¬ */
        display: inline-flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center;
        text-align: center;
        
        margin-right: 3px; 
        font-size: 0.7rem; 
        font-weight: 700;
        color: #333; 
        line-height: 1.1; 
        white-space: normal; 
        word-break: keep-all; 
        padding: 1px;
        
        transition: all 0.2s;
        pointer-events: none; user-select: none;
    }
    
    .edit-mode-active .type-btn { cursor: pointer; opacity: 1; pointer-events: auto; }
    .edit-mode-active .type-btn:hover { transform: translateY(-2px); border-color: #0d6efd; }
    .edit-mode-active .type-btn.active { border: 2px solid #212529; transform: scale(1.1); box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 2; }

    /* 7. ì…€ í¸ì§‘ ìŠ¤íƒ€ì¼ */
    .cell-editable { cursor: default; }
    .schedule-table-container.edit-mode-active .cell-editable { cursor: pointer; }
    .schedule-table-container.edit-mode-active .cell-editable:hover { opacity: 0.8; outline: 2px solid #0d6efd; outline-offset: -2px; }

    .cell-text {
        display: block;
        white-space: normal;
        line-height: 1.1;
        font-size: 0.8em;
    }

    /* 8. ì»¨íŠ¸ë¡¤ ë°•ìŠ¤ */
    .control-box { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px 15px; margin-bottom: 20px; }
</style>

<div class="container-fluid mt-4 pb-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="fw-bold text-dark m-0">
            <i class="bi bi-calendar-week-fill text-primary me-2"></i>ê·¼ë¬´í‘œ ({{ year }}.{{ month }})
        </h3>
        
        <div class="d-flex gap-2 align-items-center">
            {% if is_manager %}
            <button class="btn btn-warning shadow-sm fw-bold position-relative btn-sm text-nowrap" onclick="openApprovalModal()">
                <i class="bi bi-bell-fill"></i> ê²°ì¬
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="badge-count" style="display:none;">0</span>
            </button>
            
            <form class="d-flex gap-2 align-items-center bg-white p-1 rounded border shadow-sm">
                <select name="role" id="roleSelect" class="form-select form-select-sm border-0 fw-bold" style="width:auto;" onchange="this.form.submit()">
                    <option value="student" {% if sel_role == 'student' %}selected{% endif %}>êµìœ¡ìƒ</option>
                    <option value="manager" {% if sel_role == 'manager' %}selected{% endif %}>ë§¤ë‹ˆì €</option>
                </select>
                <div class="vr"></div>
                <select name="cohort" class="form-select form-select-sm border-0" style="width:auto;" onchange="this.form.submit()">
                    <option value="">ì „ì²´ ê¸°ìˆ˜</option>
                    {% for c in cohorts %}<option value="{{ c.id }}" {% if sel_cohort == c.id %}selected{% endif %}>{{ c.name }}</option>{% endfor %}
                </select>
                <div class="vr"></div>
                <select name="process" class="form-select form-select-sm border-0" style="width:auto;" onchange="this.form.submit()">
                    <option value="">ì „ì²´ ê³µì •</option>
                    {% for p in processes %}<option value="{{ p.id }}" {% if sel_process == p.id %}selected{% endif %}>{{ p.name }}</option>{% endfor %}
                </select>
            </form>
            {% else %}
            <div class="bg-white px-3 py-1 rounded border text-muted shadow-sm small text-nowrap">
                <i class="bi bi-person-circle"></i> ë‚´ ê³¼ì • ì¡°íšŒ
            </div>
            {% endif %}
            
            <div class="btn-group shadow-sm">
                <a href="?year={{ prev_month|slice:':4' }}&month={{ prev_month|slice:'5:' }}" class="btn btn-light border fw-bold btn-sm">â—€</a>
                <a href="?year={{ next_month|slice:':4' }}&month={{ next_month|slice:'5:' }}" class="btn btn-light border fw-bold btn-sm">â–¶</a>
            </div>
        </div>
    </div>

    <div class="control-box d-flex flex-wrap align-items-center justify-content-between shadow-sm" id="palette-toolbar">
        <div class="d-flex align-items-center gap-3">
            <div class="d-flex align-items-center">
                <strong class="me-3 text-secondary small text-nowrap"><i class="bi bi-palette-fill"></i> ê·¼ë¬´ ì„ íƒ</strong>
                <div id="type-btn-group" class="d-flex flex-wrap">
                    {% for wt in work_types %}
                        <div class="type-btn" 
                             style="background-color: {{ wt.color }};" 
                             title="{{ wt.name }}"
                             onclick="selectWorkType(this, '{{ wt.id }}', '{{ wt.color }}', '{{ wt.short_name }}')">
                            {{ wt.short_name }}
                        </div>
                    {% endfor %}
                </div>
            </div>
            <small class="text-muted border-start ps-3 d-none d-md-block" id="mode-instruction" style="font-size: 0.85em;">
                * <strong>[ìˆ˜ì •í•˜ê¸°]</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ í¸ì§‘ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
            </small>
        </div>
        
        <div class="d-flex gap-2 mt-2 mt-md-0">
            <div id="view-mode-btns" class="d-flex gap-2">
                {% if is_manager %}
                <button class="btn btn-sm btn-outline-success fw-bold text-nowrap" onclick="applyAllNormal()">
                    <i class="bi bi-magic"></i> ì „ì²´ ì •ìƒ
                </button>
                {% endif %}
                <button class="btn btn-sm btn-primary fw-bold px-3 text-nowrap" onclick="startEditMode()">
                    <i class="bi bi-pencil-square"></i> ìˆ˜ì •í•˜ê¸°
                </button>
            </div>

            <div id="edit-mode-btns" class="d-flex gap-2" style="display: none !important;">
                <button class="btn btn-sm btn-secondary fw-bold px-3 text-nowrap" onclick="cancelEditMode()">
                    ì·¨ì†Œ
                </button>
                <button class="btn btn-sm btn-danger fw-bold px-3 shadow text-nowrap" onclick="finishEditMode()">
                    <i class="bi bi-save-fill"></i> ì €ì¥
                </button>
            </div>
        </div>
    </div>

    <div class="schedule-table-container shadow-sm" id="scheduleContainer">
        <table class="schedule-table w-100 mb-0">
            <thead>
                <tr>
                    <th style="min-width: 120px; background-color: #e9ecef;">ì´ë¦„ / ê³µì •</th>
                    {% for day in days_in_month %}
                        <th class="{% if day.is_today %}today-col{% endif %} 
                                   {% if day.is_holiday %}holiday-col{% elif day.weekday == 'í† ' %}sat-col{% elif day.is_weekend %}holiday-col{% endif %}"
                            title="{{ day.holiday_name }}">
                            {{ day.day }}<br>
                            <span style="font-size:0.8em; font-weight:normal;">{{ day.weekday }}</span>
                            {% if day.is_holiday %}
                                <br><span style="font-size:0.6em;" class="badge bg-danger rounded-pill">{{ day.holiday_name|truncatechars:4 }}</span>
                            {% endif %}
                        </th>
                    {% endfor %}
                    <th class="bg-light text-secondary border-start">ì¶œê·¼</th>
                    <th class="bg-light text-secondary">íœ´ë¬´</th> <th class="bg-light text-secondary">ì—°ì°¨</th>
                    <th class="bg-light text-secondary">ë°˜ì°¨</th>
                </tr>
            </thead>
            <tbody>
                {% for pid, data in schedule_map.items %}
                <tr data-profile-id="{{ pid }}">
                    <th>
                        <div class="fw-bold text-dark" style="font-size:0.95em;">{{ data.profile.name }}</div>
                        <small class="text-muted fw-normal" style="font-size:0.8em;">{{ data.profile.process.name|default:"-" }}</small>
                    </th>
                    
                    {% for day in days_in_month %}
                        {% with cell_val=data.daily_data|get_item:day.date_str %}
                        <td class="cell-editable {% if day.is_today %}today-col{% endif %}"
                            data-date="{{ day.date_str }}"
                            onclick="applyCell(this)"
                            style="
                                {% if cell_val == 'DEFAULT_F' %}
                                    /* ê¸°ë³¸ F */
                                {% elif cell_val %}
                                    background-color: {{ cell_val.color }};
                                {% elif day.is_holiday or day.is_weekend %}
                                    background-color: #f8f9fa; color: #ced4da;
                                {% endif %}
                            ">
                            
                            <span class="cell-text fw-bold">
                                {% if cell_val == 'DEFAULT_F' %}
                                    <span class="text-secondary" style="opacity:0.3;">F</span>
                                {% elif cell_val %}
                                    {{ cell_val.short_name }}
                                {% elif day.is_holiday or day.is_weekend %}
                                    <span style="color: #dc3545; font-size: 0.8em;">íœ´ë¬´</span>
                                {% endif %}
                            </span>
                        </td>
                        {% endwith %}
                    {% endfor %}
                    
                    <td class="fw-bold text-dark bg-light border-start">{{ data.stats.work }}</td>
                    <td class="text-muted bg-light fw-bold">{{ data.stats.rest }}</td> <td class="text-danger bg-light">{{ data.stats.leave }}</td>
                    <td class="text-primary bg-light">{{ data.stats.half }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="45" class="p-5 text-center text-muted">í‘œì‹œí•  ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="approvalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title fw-bold">ê²°ì¬ ëŒ€ê¸° ëª©ë¡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <table class="table table-hover mb-0">
                    <tbody id="approvalListBody"></tbody>
                </table>
                <div id="noRequestMsg" class="text-center py-4 text-muted" style="display:none;">ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedTypeId = null;
    let selectedColor = null;
    let selectedText = null;
    let isEditMode = false;
    let pendingChanges = [];

    function startEditMode() {
        isEditMode = true;
        pendingChanges = [];
        document.getElementById('view-mode-btns').style.setProperty('display', 'none', 'important');
        document.getElementById('edit-mode-btns').style.setProperty('display', 'flex', 'important');
        document.getElementById('scheduleContainer').classList.add('edit-mode-active');
        document.getElementById('palette-toolbar').classList.add('edit-mode-active');
        document.getElementById('mode-instruction').innerHTML = '<span class="text-danger fw-bold">ìˆ˜ì • ëª¨ë“œ ON</span> (ì €ì¥ í•„ìˆ˜)';
    }

    function cancelEditMode() {
        if(pendingChanges.length > 0 && !confirm('ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤. ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        location.reload();
    }

    // [í•µì‹¬ ë¡œì§] ì €ì¥ ë²„íŠ¼ í´ë¦­ -> ì„œë²„ ì‘ë‹µì— ë”°ë¼ ì‚¬ìœ  ì…ë ¥ ì²˜ë¦¬
    async function finishEditMode() {
        if (pendingChanges.length === 0) { cancelEditMode(); return; }
        if(!confirm(`ì´ ${pendingChanges.length}ê±´ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        try {
            for (let i = 0; i < pendingChanges.length; i++) {
                let change = pendingChanges[i];
                
                // 1. ì €ì¥ ì‹œë„
                let response = await fetch("{% url 'attendance:update_schedule' %}", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                    body: JSON.stringify(change)
                });
                let data = await response.json();

                // 2. ì„œë²„ê°€ ì‚¬ìœ  ì…ë ¥ì„ ìš”êµ¬í•˜ë©´ (ìŠ¹ì¸ í•„ìš” ê±´)
                if (data.status === 'reason_required') {
                    // ì‚¬ìš©ìì—ê²Œ ì…ë ¥ ë°›ê¸°
                    let userReason = prompt(`ğŸ“ [ìŠ¹ì¸ í•„ìš”] ${change.date} ê·¼ë¬´ ë³€ê²½ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:\n(ì·¨ì†Œ ì‹œ í•´ë‹¹ ê±´ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)`);
                    
                    if (userReason) {
                        change.reason = userReason;
                        // ì‚¬ìœ ë¥¼ ë‹´ì•„ì„œ ì¬ì „ì†¡
                        let retryResponse = await fetch("{% url 'attendance:update_schedule' %}", {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                            body: JSON.stringify(change)
                        });
                        let retryData = await retryResponse.json();
                        
                        if (retryData.status === 'request_sent') {
                            console.log(`ìŠ¹ì¸ ìš”ì²­ë¨: ${change.date}`);
                        }
                    } else {
                        console.log(`ì €ì¥ ì·¨ì†Œë¨: ${change.date}`);
                    }
                }
            }
            alert("ì €ì¥ ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload();
        } catch (error) {
            console.error(error);
            alert("ì €ì¥ ì¤‘ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    function selectWorkType(el, id, color, text) {
        if (!isEditMode) return;
        document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
        el.classList.add('active');
        selectedTypeId = id;
        selectedColor = color;
        selectedText = text;
    }

    function applyCell(cell) {
        if (!isEditMode) return;
        if (!selectedTypeId) { alert('ê·¼ë¬´ ìœ í˜•ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!'); return; }
        
        const profileId = cell.parentElement.getAttribute('data-profile-id');
        const date = cell.getAttribute('data-date');

        cell.style.backgroundColor = selectedColor;
        cell.querySelector('.cell-text').innerText = selectedText;
        cell.querySelector('.cell-text').style.color = '#000'; 
        
        pendingChanges = pendingChanges.filter(c => !(c.profile_id === profileId && c.date === date));
        pendingChanges.push({ profile_id: profileId, date: date, work_type_id: selectedTypeId, reason: null });
    }

    function applyAllNormal() {
        if(!confirm("ë¹ˆ í‰ì¼ì„ ëª¨ë‘ 'ì •ìƒ ê·¼ë¬´'ë¡œ ì±„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        const profileIds = [];
        document.querySelectorAll('tr[data-profile-id]').forEach(tr => profileIds.push(tr.getAttribute('data-profile-id')));
        
        fetch("{% url 'attendance:apply_all_normal' %}", {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify({ year: {{ year }}, month: {{ month }}, profile_ids: profileIds })
        }).then(res => res.json()).then(data => {
            alert('ì ìš© ì™„ë£Œ. ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
            location.reload();
        });
    }

    // ìŠ¹ì¸ ëª¨ë‹¬ ê´€ë ¨
    function openApprovalModal() {
        const modal = new bootstrap.Modal(document.getElementById('approvalModal'));
        document.getElementById('approvalListBody').innerHTML = '<tr><td class="text-center">ë¡œë”© ì¤‘...</td></tr>';
        modal.show();
        fetch("{% url 'attendance:get_pending_requests' %}").then(res => res.json()).then(data => {
            const tbody = document.getElementById('approvalListBody');
            tbody.innerHTML = '';
            if(data.requests.length === 0) {
                document.getElementById('noRequestMsg').style.display = 'block';
            } else {
                document.getElementById('noRequestMsg').style.display = 'none';
                data.requests.forEach(req => {
                    tbody.innerHTML += `
                        <tr id="req-${req.id}">
                            <td class="fw-bold">${req.name}</td>
                            <td>${req.date}</td>
                            <td><span class="badge bg-primary">${req.type}</span></td>
                            <td class="small text-muted">${req.reason}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-success me-1" onclick="processReq(${req.id}, 'approve')">ìŠ¹ì¸</button>
                                <button class="btn btn-sm btn-danger" onclick="processReq(${req.id}, 'reject')">ê±°ì ˆ</button>
                            </td>
                        </tr>`;
                });
            }
        });
    }

    function processReq(reqId, action) {
        fetch("{% url 'attendance:process_request' %}", {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify({ request_id: reqId, action: action })
        }).then(res => res.json()).then(data => {
            document.getElementById(`req-${reqId}`).remove();
            if(document.getElementById('approvalListBody').children.length === 0) document.getElementById('noRequestMsg').style.display = 'block';
        });
    }

    window.onload = function() {
        const todayHeader = document.querySelector('.today-col');
        if (todayHeader) todayHeader.scrollIntoView({behavior: "smooth", block: "center", inline: "center"});
        
        {% if is_manager %}
        fetch("{% url 'attendance:get_pending_requests' %}").then(res => res.json()).then(data => {
            const badge = document.getElementById('badge-count');
            if(data.requests.length > 0) { badge.innerText = data.requests.length; badge.style.display = 'block'; }
        });
        {% endif %}
    };
</script>
{% endblock %}