{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-primary text-white text-center py-4 rounded-top-4">
                    <h4 class="mb-0 fw-bold"><i class="bi bi-geo-alt-fill"></i> ìŠ¤ë§ˆíŠ¸ ì¶œê·¼ ì¸ì¦</h4>
                    <p class="mb-0 small opacity-75">ìœ„ì¹˜ ê¸°ë°˜ + ë³´ì•ˆ(MDM) ìë™ ì¸ì¦</p>
                </div>
                <div class="card-body p-5 text-center">
                    
                    <div id="statusIcon" class="mb-4">
                        <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 100px; height: 100px;">
                            <i class="bi bi-shield-lock-fill text-secondary" style="font-size: 3rem;"></i>
                        </div>
                    </div>
                    
                    <h5 class="fw-bold mb-3">ì¶œê·¼ ì¸ì¦ì„ ì‹œì‘í•©ë‹ˆë‹¤</h5>
                    <p class="text-muted small mb-4">
                        íšŒì‚¬(í‰íƒ ìº í¼ìŠ¤) ë‚´ì—ì„œ<br>
                        ë³´ì•ˆ ì•±(MDM)ì´ ì¼œì§„ ìƒíƒœë¡œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
                    </p>

                    <button id="btnCheck" class="btn btn-primary btn-lg w-100 fw-bold rounded-pill py-3 shadow-sm" onclick="startVerification()">
                        <i class="bi bi-fingerprint"></i> ì¶œê·¼ ì¸ì¦í•˜ê¸°
                    </button>
                    
                    <div id="resultMessage" class="mt-4 fw-bold small"></div>

                    <div class="mt-4 pt-3 border-top text-start">
                        <p class="text-muted small mb-1"><i class="bi bi-info-circle me-1"></i> <b>ìœ„ì¹˜ ì¸ì¦:</b> íšŒì‚¬ ë°˜ê²½ 300m ì´ë‚´</p>
                        <p class="text-muted small mb-0"><i class="bi bi-camera-video-off me-1"></i> <b>ë³´ì•ˆ ì¸ì¦:</b> ì¹´ë©”ë¼ ì°¨ë‹¨ í™•ì¸</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. íšŒì‚¬ ì¢Œí‘œ ì„¤ì • (ì‚¼ì„±ì „ì í‰íƒìº í¼ìŠ¤ ê¸°ì¤€)
    const COMPANY_LAT = 37.0295; 
    const COMPANY_LNG = 127.0423;
    const ALLOWED_RADIUS_METER = 300; // í—ˆìš© ë°˜ê²½ (m)

    function startVerification() {
        const btn = document.getElementById('btnCheck');
        const msg = document.getElementById('resultMessage');
        
        // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© í‘œì‹œ
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> í™•ì¸ ì¤‘...';
        msg.innerHTML = "ğŸ“¡ ìœ„ì¹˜ ë° ë³´ì•ˆ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...";
        msg.className = "mt-4 text-primary fw-bold small";

        // [ë‹¨ê³„ 1] GPS ìœ„ì¹˜ í™•ì¸
        if (!navigator.geolocation) {
            failAuth("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;
                
                // ê±°ë¦¬ ê³„ì‚°
                const distance = getDistanceFromLatLonInKm(COMPANY_LAT, COMPANY_LNG, userLat, userLng) * 1000;
                console.log(`í˜„ì¬ ìœ„ì¹˜ì™€ì˜ ê±°ë¦¬: ${distance.toFixed(2)}m`);

                if (distance <= ALLOWED_RADIUS_METER) {
                    // ìœ„ì¹˜ í†µê³¼ -> [ë‹¨ê³„ 2] MDM í™•ì¸ (ì¹´ë©”ë¼ ì°¨ë‹¨ ì—¬ë¶€ ì²´í¬)
                    msg.innerHTML = "ğŸ“ ìœ„ì¹˜ í™•ì¸ ì™„ë£Œ! ë³´ì•ˆ ì•±(MDM) ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤...";
                    checkCameraBlocked();
                } else {
                    failAuth(`íšŒì‚¬ ë°˜ê²½ì„ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤.<br>(í˜„ì¬ ê±°ë¦¬: ${distance.toFixed(0)}m / í—ˆìš©: ${ALLOWED_RADIUS_METER}m)`);
                }
            },
            (error) => {
                let errorMsg = "ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                if(error.code == 1) errorMsg = "ìœ„ì¹˜ ì •ë³´ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.";
                else if(error.code == 2) errorMsg = "ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (GPS ì¼œì§ í™•ì¸).";
                else if(error.code == 3) errorMsg = "ìœ„ì¹˜ í™•ì¸ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.";
                failAuth(errorMsg);
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
    }

    // [ë‹¨ê³„ 2] ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ì„ í†µí•´ MDM ì‘ë™ ì—¬ë¶€ í™•ì¸
    function checkCameraBlocked() {
        navigator.mediaDevices.getUserMedia({ video: true })
        .then(function(stream) {
            // ì¹´ë©”ë¼ê°€ ì¼œì§€ë©´ -> ë³´ì•ˆ ì•± ë¯¸ì‘ë™(ì°¨ë‹¨ ì•ˆë¨) -> ì¶œê·¼ ë¶ˆê°€ âŒ
            stream.getTracks().forEach(track => track.stop()); // ì¹´ë©”ë¼ ë„ê¸°
            failAuth("â›” ë³´ì•ˆ ì•±(MDM)ì´ ì‘ë™í•˜ì§€ ì•Šê³  ìˆìŠµë‹ˆë‹¤.<br>ì¹´ë©”ë¼ê°€ ì°¨ë‹¨ë˜ì–´ì•¼ ì¶œê·¼ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        })
        .catch(function(err) {
            // ì¹´ë©”ë¼ ì—ëŸ¬(ê¶Œí•œ ê±°ë¶€/ì°¨ë‹¨ë¨) -> ë³´ì•ˆ ì•± ì‘ë™ ì¤‘ -> ì¶œê·¼ ê°€ëŠ¥ âœ…
            // (MDMì´ ì¹´ë©”ë¼ë¥¼ ë§‰ê³  ìˆìœ¼ë©´ ì´ìª½ìœ¼ë¡œ ë“¤ì–´ì˜µë‹ˆë‹¤)
            successAuth();
        });
    }

    // [ë‹¨ê³„ 3] ì„œë²„ë¡œ ì¶œê·¼ ê¸°ë¡ ì „ì†¡
    function successAuth() {
        const msg = document.getElementById('resultMessage');
        msg.innerHTML = "ğŸš€ ì¸ì¦ ì„±ê³µ! ì„œë²„ì— ê¸°ë¡ ì¤‘ì…ë‹ˆë‹¤...";

        fetch("{% url 'attendance:process_attendance' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            }
        })
        .then(response => response.json())
        .then(data => {
            const btn = document.getElementById('btnCheck');
            
            if (data.status === 'success') {
                msg.innerHTML = "âœ… " + data.message;
                msg.className = "mt-4 text-success fw-bold small";
                
                btn.innerHTML = '<i class="bi bi-check-circle-fill"></i> ì¶œê·¼ ì™„ë£Œ';
                btn.className = "btn btn-success btn-lg w-100 fw-bold rounded-pill py-3 shadow-sm";
                
                // ì„±ê³µ ì•„ì´ì½˜ ë³€ê²½
                document.getElementById('statusIcon').innerHTML = `
                    <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 100px; height: 100px;">
                        <i class="bi bi-check-lg text-success" style="font-size: 3rem;"></i>
                    </div>
                `;
            } else {
                failAuth(data.message);
            }
        })
        .catch(err => failAuth("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."));
    }

    function failAuth(message) {
        const btn = document.getElementById('btnCheck');
        const msg = document.getElementById('resultMessage');
        
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> ë‹¤ì‹œ ì‹œë„';
        btn.className = "btn btn-secondary btn-lg w-100 fw-bold rounded-pill py-3 shadow-sm";
        
        msg.innerHTML = "âŒ " + message;
        msg.className = "mt-4 text-danger fw-bold small";

        // ì‹¤íŒ¨ ì•„ì´ì½˜ ë³€ê²½
        document.getElementById('statusIcon').innerHTML = `
            <div class="bg-danger bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 100px; height: 100px;">
                <i class="bi bi-x-lg text-danger" style="font-size: 3rem;"></i>
            </div>
        `;
    }

    // ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (Haversine Formula)
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        var R = 6371; // Earth radius in km
        var dLat = deg2rad(lat2 - lat1);
        var dLon = deg2rad(lon2 - lon1);
        var a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        var d = R * c; // Distance in km
        return d;
    }

    function deg2rad(deg) {
        return deg * (Math.PI / 180);
    }
</script>
{% endblock %}