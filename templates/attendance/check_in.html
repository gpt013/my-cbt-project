{% extends 'base.html' %}
{% block content %}
<div class="container mt-5 text-center">
    <h2>ğŸ¢ ì¶œê·¼ ì¸ì¦ (ë³´ì•ˆ/ìœ„ì¹˜)</h2>
    <div class="card p-4 mt-3">
        <p class="text-muted">
            ë°˜ë“œì‹œ <b>ë³´ì•ˆ ì•±(MDM)</b>ì„ ì‹¤í–‰í•˜ì—¬ ì¹´ë©”ë¼ë¥¼ ì ê·¼ í›„,<br>
            ì‚¬ì—…ì¥ ë‚´ì—ì„œ <b>[ì¸ì¦í•˜ê¸°]</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
        </p>
        
        <div id="status-box" class="alert alert-secondary">
            ëŒ€ê¸° ì¤‘...
        </div>

        <button id="btn-check-in" class="btn btn-primary btn-lg" onclick="startCheckIn()">
            ğŸ“ ìœ„ì¹˜ ë° ë³´ì•ˆ í™•ì¸ í›„ ì¶œê·¼
        </button>
    </div>
</div>

<script>
    async function startCheckIn() {
        const statusBox = document.getElementById('status-box');
        const btn = document.getElementById('btn-check-in');
        
        btn.disabled = true;
        statusBox.className = 'alert alert-info';
        statusBox.innerText = "1ë‹¨ê³„: ë³´ì•ˆ ì•±(MDM) ì‘ë™ ì—¬ë¶€ í™•ì¸ ì¤‘... (ì¹´ë©”ë¼ ì ‘ê·¼ ì‹œë„)";

        // 1ï¸âƒ£ MDM í™•ì¸ (ì¹´ë©”ë¼ ì‹¤í–‰ ì‹œë„)
        // ë…¼ë¦¬: MDMì´ ì¼œì ¸ìˆìœ¼ë©´ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹œ ì—ëŸ¬ê°€ ë‚˜ì•¼ ì •ìƒ!
        // ì¹´ë©”ë¼ê°€ ì¼œì§€ë©´ -> MDM ì•ˆ í‚¨ ê²ƒ -> ì¶œê·¼ ë¶ˆê°€
        let isMdmActive = false;
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            
            // ì—¬ê¸°ê¹Œì§€ ì™”ë‹¤ëŠ” ê±´ ì¹´ë©”ë¼ê°€ ì¼œì¡Œë‹¤ëŠ” ëœ» (MDM ë¯¸ì‘ë™)
            stream.getTracks().forEach(track => track.stop()); // ì¹´ë©”ë¼ ë„ê¸°
            statusBox.className = 'alert alert-danger';
            statusBox.innerHTML = "â›” <b>ì¶œê·¼ ë¶ˆê°€</b><br>ì¹´ë©”ë¼ê°€ ì‘ë™ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ë³´ì•ˆ ì•±(MDM)ì„ ì‹¤í–‰í•˜ì—¬ ì¹´ë©”ë¼ë¥¼ ì°¨ë‹¨í•´ì£¼ì„¸ìš”.";
            btn.disabled = false;
            return; 

        } catch (err) {
            // ì—ëŸ¬ ë°œìƒ = ì¹´ë©”ë¼ ì°¨ë‹¨ë¨ = MDM ì‘ë™ ì¤‘ (ë˜ëŠ” ê¶Œí•œ ê±°ë¶€)
            // ì‹¤ì œ ìƒí™©ì—ì„œëŠ” ìœ ì €ê°€ ë¸Œë¼ìš°ì € ê¶Œí•œì„ 'í—ˆìš©'í–ˆëŠ”ë°ë„ OS/MDMì´ ë§‰ì•„ì„œ ì—ëŸ¬ë‚œ ê²ƒì„ ê°ì§€í•´ì•¼ í•¨.
            // ì—¬ê¸°ì„œëŠ” 'ì—ëŸ¬ë‚˜ë©´ í†µê³¼'ë¡œ ì²˜ë¦¬
            console.log("ì¹´ë©”ë¼ ì°¨ë‹¨ í™•ì¸ë¨ (ì •ìƒ):", err);
            isMdmActive = true;
        }

        if (isMdmActive) {
            statusBox.innerText = "2ë‹¨ê³„: í˜„ì¬ ìœ„ì¹˜ í™•ì¸ ì¤‘...";
            
            // 2ï¸âƒ£ ìœ„ì¹˜ í™•ì¸ (GPS)
            if (!navigator.geolocation) {
                statusBox.className = 'alert alert-danger';
                statusBox.innerText = "ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    statusBox.innerText = "3ë‹¨ê³„: ì„œë²„ë¡œ ì „ì†¡ ì¤‘...";
                    sendData(lat, lon, true); // MDM Active = true
                },
                (error) => {
                    statusBox.className = 'alert alert-danger';
                    statusBox.innerText = "âŒ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. GPSë¥¼ ì¼œì£¼ì„¸ìš”.";
                    btn.disabled = false;
                },
                { enableHighAccuracy: true } // ë†’ì€ ì •í™•ë„ ìš”êµ¬
            );
        }
    }

    function sendData(lat, lon, mdmStatus) {
        const statusBox = document.getElementById('status-box');
        
        fetch("{% url 'attendance:check_in_api' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                lat: lat,
                lon: lon,
                is_mdm_active: mdmStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                statusBox.className = 'alert alert-success';
                statusBox.innerHTML = `âœ… <b>ì„±ê³µ</b><br>${data.message}`;
                // í˜ì´ì§€ ì´ë™ ë˜ëŠ” ë²„íŠ¼ ìˆ¨ê¹€
                document.getElementById('btn-check-in').style.display = 'none';
            } else {
                statusBox.className = 'alert alert-warning';
                statusBox.innerHTML = `âš ï¸ <b>ì‹¤íŒ¨</b><br>${data.message}`;
                document.getElementById('btn-check-in').disabled = false;
            }
        })
        .catch(error => {
            statusBox.className = 'alert alert-danger';
            statusBox.innerText = "ì„œë²„ í†µì‹  ì˜¤ë¥˜ ë°œìƒ";
            document.getElementById('btn-check-in').disabled = false;
        });
    }
</script>
{% endblock %}